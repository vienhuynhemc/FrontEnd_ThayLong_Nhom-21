{"ast":null,"code":"import _asyncToGenerator from \"E:/Important/FIT/project-front-end/FrontEnd_ThayLong_Nhom-21/app-chat/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport { UserVideo } from 'src/app/models/firebase/chat-page/call-video/user-video';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/fire/database\";\nimport * as i2 from \"src/app/service/firebase/my-name/my-name.service\";\nimport * as i3 from \"src/app/service/firebase/main-page/main-page.service\";\nimport * as i4 from \"./../chat-page-chat-page/chat-page-chat-page-content/chat-page-chat-page-content.service\";\nimport * as i5 from \"./../chat-page-chat-page/messenger-main.service\";\nexport class CallVideoService {\n  constructor(db, my_name_service, main_page_service, content_service, messenger_main_service) {\n    this.db = db;\n    this.my_name_service = my_name_service;\n    this.main_page_service = main_page_service;\n    this.content_service = content_service;\n    this.messenger_main_service = messenger_main_service; // Request mediaDevices\n\n    this.mediaConstraints = {\n      audio: true,\n      video: true\n    }; // All user\n\n    this.all_user = []; // request 45s\n\n    this.countRequest = 0;\n\n    if (this.layAllUser == null) {\n      this.getData();\n    } else {\n      this.layAllUser.unsubscribe();\n      this.getData();\n    }\n  }\n\n  getData() {\n    this.layAllUser = this.db.object(\"/call_video\").snapshotChanges().subscribe(data => {\n      let array = [];\n      let isCall = false;\n      let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn\"));\n      Object.entries(data.payload.toJSON()).forEach(([k, v]) => {\n        let o = new UserVideo();\n        o.ma_tai_khoan = k;\n        o.bat_may_chua = v['bat_may_chua'];\n        o.goi_chua = v['goi_chua'];\n        o.thoi_gian_goi = v['thoi_gian_goi'];\n        o.thoi_gian_ket_thuc = v['thoi_gian_ket_thuc'];\n        o.tk_goi_minh = v['tk_goi_minh'];\n        o.hinh_tk_goi_minh = v['hinh_tk_goi_minh'];\n        o.ten_tk_goi_minh = v['ten_tk_goi_minh']; // Đang trong cuộc gọi\n\n        if (k == mtk && o.goi_chua == 'dang') {\n          isCall = true;\n        }\n\n        array.push(o);\n      });\n      this.all_user = array;\n\n      if (isCall) {\n        this.getVideoUserAndShow();\n      } else {\n        this.is_close_camera = false;\n\n        try {\n          this.localStream.getTracks().forEach(function (track) {\n            track.enabled = true;\n          });\n        } catch (_a) {}\n\n        this.is_show = false;\n      }\n    });\n  }\n\n  getVideoUserAndShow() {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      _this.localStream = yield navigator.mediaDevices.getUserMedia(_this.mediaConstraints);\n      _this.is_show = true;\n    })();\n  }\n\n  callVideo(tk) {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* () {\n      _this2.now_user = tk; // Check thử available\n\n      if (_this2.isAvailable(tk.ma_tai_khoan)) {\n        // Lấy video\n        _this2.getVideoUserAndShow(); // Cập nhật lại trong firebase\n\n\n        _this2.writeToFirebase(tk); // Time out 45s\n\n\n        _this2.countRequest = 0;\n\n        _this2.request45second(); // Status là gọi\n\n\n        _this2.status = 1;\n      } else {\n        // Lấy video\n        _this2.localStream = null;\n        _this2.is_show = true;\n      }\n    })();\n  }\n\n  request45second() {\n    setTimeout(() => {\n      this.countRequest++;\n\n      if (this.countRequest <= 45) {\n        let isOk = false;\n\n        for (let i = 0; i < this.all_user.length; i++) {\n          if (this.all_user[i].ma_tai_khoan == this.now_user.ma_tai_khoan) {\n            if (this.all_user[i].bat_may_chua == 'roi') {\n              isOk = true;\n            }\n\n            break;\n          }\n        }\n\n        if (!isOk) {\n          this.request45second();\n        } else {\n          // Có người bắt máy\n          // Chuyển status sang bắt máy\n          this.status = 2;\n        }\n      } else {\n        this.cuocGoiNho();\n      }\n    }, 1000);\n  }\n\n  writeToFirebase(tk) {\n    let currentTime = Number(new Date());\n    let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn\"));\n    this.db.object(\"/call_video/\" + tk.ma_tai_khoan).update({\n      thoi_gian_goi: currentTime,\n      goi_chua: \"dang\",\n      bat_may_chua: \"chua\",\n      tk_goi_minh: mtk,\n      hinh_tk_goi_minh: this.main_page_service.img,\n      ten_tk_goi_minh: this.my_name_service.myName\n    });\n    this.db.object(\"/call_video/\" + mtk).update({\n      thoi_gian_goi: currentTime,\n      goi_chua: \"dang\",\n      bat_may_chua: \"roi\",\n      tk_goi_minh: 'khong_co',\n      hinh_tk_goi_minh: 'khong_co',\n      ten_tk_goi_minh: 'khong_co'\n    });\n  }\n\n  isAvailable(mtk) {\n    for (let i = 0; i < this.all_user.length; i++) {\n      if (this.all_user[i].ma_tai_khoan == mtk) {\n        if (this.all_user[i].goi_chua == 'dang') {\n          return false;\n        }\n\n        break;\n      }\n    }\n\n    return true;\n  }\n\n  startVideo() {\n    this.is_close_camera = false;\n    this.localStream.getTracks().forEach(function (track) {\n      track.enabled = true;\n    });\n  }\n\n  offVideo() {\n    this.is_close_camera = true;\n    this.localStream.getTracks().forEach(function (track) {\n      track.enabled = false;\n    });\n  }\n\n  close() {\n    // countRequest\n    if (this.status == 1) {\n      this.countRequest = 45;\n    } else if (this.status == 2) {\n      // view\n      this.is_show = false;\n      this.localStream.getTracks().forEach(function (track) {\n        track.stop();\n      });\n      this.is_close_camera = false; // data\n\n      this.closeData();\n    }\n  }\n\n  cuocGoiNho() {\n    // view\n    this.is_show = false;\n    this.localStream.getTracks().forEach(function (track) {\n      track.stop();\n    });\n    this.is_close_camera = false; // data\n\n    this.closeData(); // Tạo tin nhắn cuộc gọi nhỡ\n\n    this.createTinNhan();\n  }\n\n  createTinNhan() {\n    let nowDate = new Date();\n    let gio = nowDate.getHours();\n    let phut = nowDate.getMinutes();\n    let noi_dung = `${gio.toString().length > 1 ? gio : \"0\" + gio}:${phut.toString().length > 1 ? phut : \"0\" + phut}`;\n    this.content_service.sumitTinNhan(this.messenger_main_service.ma_cuoc_tro_chuyen, noi_dung, \"cuoc_goi_nho\", this.my_name_service.myName);\n  }\n\n  closeData() {\n    let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn\"));\n    this.db.object(\"/call_video/\" + this.now_user.ma_tai_khoan).update({\n      goi_chua: \"chua\"\n    });\n    this.db.object(\"/call_video/\" + mtk).update({\n      goi_chua: \"chua\"\n    });\n  }\n\n  cameraGoToLeft() {\n    this.is_camera_go_to_left = !this.is_camera_go_to_left;\n  }\n\n}\n\nCallVideoService.ɵfac = function CallVideoService_Factory(t) {\n  return new (t || CallVideoService)(i0.ɵɵinject(i1.AngularFireDatabase), i0.ɵɵinject(i2.MyNameService), i0.ɵɵinject(i3.MainPageService), i0.ɵɵinject(i4.ChatPageChatPageContentService), i0.ɵɵinject(i5.MessengerMainService));\n};\n\nCallVideoService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: CallVideoService,\n  factory: CallVideoService.ɵfac,\n  providedIn: 'root'\n});","map":{"version":3,"sources":["E:\\Important\\FIT\\project-front-end\\FrontEnd_ThayLong_Nhom-21\\app-chat\\src\\app\\service\\firebase\\chat-page\\call-video\\call-video.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { MessengerMainService } from './../chat-page-chat-page/messenger-main.service';\r\nimport { ChatPageChatPageContentService } from './../chat-page-chat-page/chat-page-chat-page-content/chat-page-chat-page-content.service';\r\nimport { MainPageService } from 'src/app/service/firebase/main-page/main-page.service';\r\nimport { MyNameService } from 'src/app/service/firebase/my-name/my-name.service';\r\nimport { AngularFireDatabase } from '@angular/fire/database';\r\nimport { Subscription } from 'rxjs';\r\nimport { Injectable } from '@angular/core';\r\nimport { UserVideo } from 'src/app/models/firebase/chat-page/call-video/user-video';\r\nimport { ObjectChatThanhVien } from 'src/app/models/firebase/chat-page/chat-page-chat-page/header/object_chat_thanh_vien';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CallVideoService {\r\n\r\n  // Request mediaDevices\r\n  public mediaConstraints = {\r\n    audio: true,\r\n    video: true\r\n  }\r\n\r\n  // localStream\r\n  public localStream: MediaStream;\r\n\r\n  // is show component call video\r\n  public is_show: boolean;\r\n\r\n  // Trạng thái camera bật hay tắt\r\n  public is_close_camera: boolean;\r\n  // Trạng thái my camera go to left\r\n  public is_camera_go_to_left: boolean;\r\n\r\n  // All user\r\n  public all_user: UserVideo[] = [];\r\n  // user đang tương tác\r\n  public now_user: ObjectChatThanhVien;\r\n  // request 45s\r\n  public countRequest = 0;\r\n  // Trạng thái \r\n  public status: number;\r\n\r\n  // service\r\n  public layAllUser: Subscription;\r\n\r\n  constructor(\r\n    private db: AngularFireDatabase,\r\n    private my_name_service: MyNameService,\r\n    private main_page_service: MainPageService,\r\n    private content_service: ChatPageChatPageContentService,\r\n    private messenger_main_service: MessengerMainService\r\n  ) {\r\n    if (this.layAllUser == null) {\r\n      this.getData();\r\n    } else {\r\n      this.layAllUser.unsubscribe();\r\n      this.getData();\r\n    }\r\n  }\r\n\r\n  public getData() {\r\n    this.layAllUser = this.db.object(\"/call_video\").snapshotChanges().subscribe(data => {\r\n      let array: UserVideo[] = [];\r\n      let isCall = false;\r\n      let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn\"));\r\n      Object.entries(data.payload.toJSON()).forEach(([k, v]) => {\r\n        let o = new UserVideo();\r\n        o.ma_tai_khoan = k;\r\n        o.bat_may_chua = v['bat_may_chua'];\r\n        o.goi_chua = v['goi_chua'];\r\n        o.thoi_gian_goi = v['thoi_gian_goi'];\r\n        o.thoi_gian_ket_thuc = v['thoi_gian_ket_thuc'];\r\n        o.tk_goi_minh = v['tk_goi_minh'];\r\n        o.hinh_tk_goi_minh = v['hinh_tk_goi_minh'];\r\n        o.ten_tk_goi_minh = v['ten_tk_goi_minh'];\r\n        // Đang trong cuộc gọi\r\n        if (k == mtk && o.goi_chua == 'dang') {\r\n          isCall = true;\r\n        }\r\n        array.push(o);\r\n      });\r\n      this.all_user = array;\r\n      if (isCall) {\r\n        this.getVideoUserAndShow()\r\n      } else {\r\n        this.is_close_camera = false\r\n        try {\r\n          this.localStream.getTracks().forEach(function (track) {\r\n            track.enabled = true;\r\n          });\r\n        } catch {\r\n\r\n        }\r\n        this.is_show = false;\r\n      }\r\n    })\r\n  }\r\n\r\n  public async getVideoUserAndShow() {\r\n    this.localStream = await navigator.mediaDevices.getUserMedia(this.mediaConstraints);\r\n    this.is_show = true;\r\n  }\r\n\r\n  public async callVideo(tk: ObjectChatThanhVien) {\r\n    this.now_user = tk;\r\n    // Check thử available\r\n    if (this.isAvailable(tk.ma_tai_khoan)) {\r\n      // Lấy video\r\n      this.getVideoUserAndShow();\r\n      // Cập nhật lại trong firebase\r\n      this.writeToFirebase(tk);\r\n      // Time out 45s\r\n      this.countRequest = 0;\r\n      this.request45second();\r\n      // Status là gọi\r\n      this.status = 1;\r\n    } else {\r\n      // Lấy video\r\n      this.localStream = null;\r\n      this.is_show = true;\r\n    }\r\n  }\r\n\r\n  public request45second() {\r\n    setTimeout(() => {\r\n      this.countRequest++;\r\n      if (this.countRequest <= 45) {\r\n        let isOk = false;\r\n        for (let i = 0; i < this.all_user.length; i++) {\r\n          if (this.all_user[i].ma_tai_khoan == this.now_user.ma_tai_khoan) {\r\n            if (this.all_user[i].bat_may_chua == 'roi') {\r\n              isOk = true;\r\n            }\r\n            break;\r\n          }\r\n        }\r\n        if (!isOk) {\r\n          this.request45second();\r\n        } else {\r\n          // Có người bắt máy\r\n          // Chuyển status sang bắt máy\r\n          this.status = 2;\r\n        }\r\n      } else {\r\n        this.cuocGoiNho();\r\n      }\r\n    }, 1000);\r\n  }\r\n\r\n  public writeToFirebase(tk: ObjectChatThanhVien) {\r\n    let currentTime = Number(new Date());\r\n    let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn\"));\r\n    this.db.object(\"/call_video/\" + tk.ma_tai_khoan).update({\r\n      thoi_gian_goi: currentTime,\r\n      goi_chua: \"dang\",\r\n      bat_may_chua: \"chua\",\r\n      tk_goi_minh: mtk,\r\n      hinh_tk_goi_minh: this.main_page_service.img,\r\n      ten_tk_goi_minh: this.my_name_service.myName\r\n    });\r\n    this.db.object(\"/call_video/\" + mtk).update({\r\n      thoi_gian_goi: currentTime,\r\n      goi_chua: \"dang\",\r\n      bat_may_chua: \"roi\",\r\n      tk_goi_minh: 'khong_co',\r\n      hinh_tk_goi_minh: 'khong_co',\r\n      ten_tk_goi_minh: 'khong_co'\r\n    });\r\n  }\r\n\r\n  public isAvailable(mtk: string): boolean {\r\n    for (let i = 0; i < this.all_user.length; i++) {\r\n      if (this.all_user[i].ma_tai_khoan == mtk) {\r\n        if (this.all_user[i].goi_chua == 'dang') {\r\n          return false;\r\n        }\r\n        break;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public startVideo() {\r\n    this.is_close_camera = false\r\n    this.localStream.getTracks().forEach(function (track) {\r\n      track.enabled = true;\r\n    });\r\n  }\r\n\r\n  public offVideo() {\r\n    this.is_close_camera = true;\r\n    this.localStream.getTracks().forEach(function (track) {\r\n      track.enabled = false;\r\n    });\r\n  }\r\n\r\n  public close() {\r\n    // countRequest\r\n    if (this.status == 1) {\r\n      this.countRequest = 45;\r\n    } else if (this.status == 2) {\r\n      // view\r\n      this.is_show = false;\r\n      this.localStream.getTracks().forEach(function (track) {\r\n        track.stop();\r\n      });\r\n      this.is_close_camera = false;\r\n      // data\r\n      this.closeData();\r\n    }\r\n  }\r\n\r\n  public cuocGoiNho() {\r\n    // view\r\n    this.is_show = false;\r\n    this.localStream.getTracks().forEach(function (track) {\r\n      track.stop();\r\n    });\r\n    this.is_close_camera = false;\r\n    // data\r\n    this.closeData();\r\n    // Tạo tin nhắn cuộc gọi nhỡ\r\n    this.createTinNhan();\r\n  }\r\n\r\n  public createTinNhan() {\r\n    let nowDate = new Date();\r\n    let gio = nowDate.getHours();\r\n    let phut = nowDate.getMinutes();\r\n    let noi_dung = `${gio.toString().length > 1 ? gio : \"0\" + gio}:${phut.toString().length > 1 ? phut : \"0\" + phut}`\r\n    this.content_service.sumitTinNhan(this.messenger_main_service.ma_cuoc_tro_chuyen, noi_dung, \"cuoc_goi_nho\", this.my_name_service.myName);\r\n  }\r\n\r\n  public closeData() {\r\n    let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn\"));\r\n    this.db.object(\"/call_video/\" + this.now_user.ma_tai_khoan).update({\r\n      goi_chua: \"chua\",\r\n    });\r\n    this.db.object(\"/call_video/\" + mtk).update({\r\n      goi_chua: \"chua\",\r\n    });\r\n  }\r\n\r\n  public cameraGoToLeft() {\r\n    this.is_camera_go_to_left = !this.is_camera_go_to_left;\r\n  }\r\n\r\n}\r\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}