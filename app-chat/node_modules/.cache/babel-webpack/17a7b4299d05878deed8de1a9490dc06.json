{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/Administrator/Desktop/FrontEnd_ThayLong_Nhom-21/app-chat/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport { UserVideo } from 'src/app/models/chat-page/call-video/user-video';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/fire/database\";\nimport * as i2 from \"src/app/service/my-name/my-name.service\";\nimport * as i3 from \"src/app/service/main-page/main-page.service\";\nexport class CallVideoService {\n  constructor(db, my_name_service, main_page_service) {\n    this.db = db;\n    this.my_name_service = my_name_service;\n    this.main_page_service = main_page_service; // Request mediaDevices\n\n    this.mediaConstraints = {\n      audio: true,\n      video: true\n    }; // All user\n\n    this.all_user = []; // request 45s\n\n    this.countRequest = 0;\n\n    if (this.layAllUser == null) {\n      this.getData();\n    } else {\n      this.layAllUser.unsubscribe();\n      this.getData();\n    }\n  }\n\n  getData() {\n    this.layAllUser = this.db.object(\"/call_video\").snapshotChanges().subscribe(data => {\n      let array = [];\n      Object.entries(data.payload.toJSON()).forEach(([k, v]) => {\n        let o = new UserVideo();\n        o.ma_tai_khoan = k;\n        o.bat_may_chua = v['bat_may_chua'];\n        o.goi_chua = v['goi_chua'];\n        o.thoi_gian_goi = v['thoi_gian_goi'];\n        o.thoi_gian_ket_thuc = v['thoi_gian_ket_thuc'];\n        o.tk_goi_minh = v['tk_goi_minh'];\n        o.hinh_tk_goi_minh = v['hinh_tk_goi_minh'];\n        o.ten_tk_goi_minh = v['ten_tk_goi_minh'];\n        array.push(o);\n      });\n      this.all_user = array;\n    });\n  }\n\n  callVideo(tk) {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      _this.now_user = tk; // Check thử available\n\n      if (_this.isAvailable(tk.ma_tai_khoan)) {\n        // Lấy video\n        _this.localStream = yield navigator.mediaDevices.getUserMedia(_this.mediaConstraints);\n        _this.is_show = true; // Cập nhật lại trong firebase\n\n        _this.writeToFirebase(tk); // Time out 45s\n\n\n        _this.countRequest = 0;\n\n        _this.request45second();\n      } else {\n        // Lấy video\n        _this.localStream = null;\n        _this.is_show = true;\n      }\n    })();\n  }\n\n  request45second() {\n    setTimeout(() => {\n      this.countRequest++;\n\n      if (this.countRequest <= 45) {\n        let isOk = false;\n\n        for (let i = 0; i < this.all_user.length; i++) {\n          if (this.all_user[i].ma_tai_khoan == this.now_user.ma_tai_khoan) {\n            if (this.all_user[i].bat_may_chua == 'roi') {\n              isOk = true;\n            }\n\n            break;\n          }\n        }\n\n        if (!isOk) {\n          this.request45second();\n        }\n      } else {\n        this.cuocGoiNho();\n      }\n    }, 1000);\n  }\n\n  writeToFirebase(tk) {\n    let currentTime = Number(new Date());\n    let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn\"));\n    this.db.object(\"/call_video/\" + tk.ma_tai_khoan).update({\n      thoi_gian_goi: currentTime,\n      goi_chua: \"dang\",\n      bat_may_chua: \"chua\",\n      tk_goi_minh: mtk,\n      hinh_tk_goi_minh: this.main_page_service.img,\n      ten_tk_goi_minh: this.my_name_service.myName\n    });\n    this.db.object(\"/call_video/\" + mtk).update({\n      thoi_gian_goi: currentTime,\n      goi_chua: \"dang\",\n      bat_may_chua: \"roi\",\n      tk_goi_minh: 'khong_co',\n      hinh_tk_goi_minh: 'khong_co',\n      ten_tk_goi_minh: 'khong_co'\n    });\n  }\n\n  isAvailable(mtk) {\n    for (let i = 0; i < this.all_user.length; i++) {\n      if (this.all_user[i].ma_tai_khoan == mtk) {\n        if (this.all_user[i].goi_chua == 'dang') {\n          return false;\n        }\n\n        break;\n      }\n    }\n\n    return true;\n  }\n\n  startVideo() {\n    this.is_close_camera = false;\n    this.localStream.getTracks().forEach(function (track) {\n      track.enabled = true;\n    });\n  }\n\n  offVideo() {\n    this.is_close_camera = true;\n    this.localStream.getTracks().forEach(function (track) {\n      track.enabled = false;\n    });\n  }\n\n  close() {\n    // countRequest\n    this.countRequest = 45;\n  }\n\n  cuocGoiNho() {\n    // view\n    this.is_show = false;\n    this.localStream.getTracks().forEach(function (track) {\n      track.stop();\n    });\n    this.is_close_camera = false; // data\n\n    this.closeData();\n  }\n\n  closeData() {\n    let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn\"));\n    this.db.object(\"/call_video/\" + this.now_user.ma_tai_khoan).update({\n      goi_chua: \"chua\"\n    });\n    this.db.object(\"/call_video/\" + mtk).update({\n      goi_chua: \"chua\"\n    });\n  }\n\n  cameraGoToLeft() {\n    this.is_camera_go_to_left = !this.is_camera_go_to_left;\n  }\n\n}\n\nCallVideoService.ɵfac = function CallVideoService_Factory(t) {\n  return new (t || CallVideoService)(i0.ɵɵinject(i1.AngularFireDatabase), i0.ɵɵinject(i2.MyNameService), i0.ɵɵinject(i3.MainPageService));\n};\n\nCallVideoService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: CallVideoService,\n  factory: CallVideoService.ɵfac,\n  providedIn: 'root'\n});","map":{"version":3,"sources":["C:\\Users\\Administrator\\Desktop\\FrontEnd_ThayLong_Nhom-21\\app-chat\\src\\app\\service\\chat-page\\call-video\\call-video.service.ts"],"names":[],"mappings":";AAMA,SAAS,SAAT,QAA0B,gDAA1B;;;;;AAKA,OAAM,MAAO,gBAAP,CAAuB;AA6B3B,EAAA,WAAA,CACU,EADV,EAEU,eAFV,EAGU,iBAHV,EAG4C;AAFlC,SAAA,EAAA,GAAA,EAAA;AACA,SAAA,eAAA,GAAA,eAAA;AACA,SAAA,iBAAA,GAAA,iBAAA,CAAkC,CA9B5C;;AACO,SAAA,gBAAA,GAAmB;AACxB,MAAA,KAAK,EAAE,IADiB;AAExB,MAAA,KAAK,EAAE;AAFiB,KAAnB,CA6BqC,CAb5C;;AACO,SAAA,QAAA,GAAwB,EAAxB,CAYqC,CAT5C;;AACO,SAAA,YAAA,GAAe,CAAf;;AAUL,QAAI,KAAK,UAAL,IAAmB,IAAvB,EAA6B;AAC3B,WAAK,OAAL;AACD,KAFD,MAEO;AACL,WAAK,UAAL,CAAgB,WAAhB;AACA,WAAK,OAAL;AACD;AACF;;AAEM,EAAA,OAAO,GAAA;AACZ,SAAK,UAAL,GAAkB,KAAK,EAAL,CAAQ,MAAR,CAAe,aAAf,EAA8B,eAA9B,GAAgD,SAAhD,CAA0D,IAAI,IAAG;AACjF,UAAI,KAAK,GAAgB,EAAzB;AACA,MAAA,MAAM,CAAC,OAAP,CAAe,IAAI,CAAC,OAAL,CAAa,MAAb,EAAf,EAAsC,OAAtC,CAA8C,CAAC,CAAC,CAAD,EAAI,CAAJ,CAAD,KAAW;AACvD,YAAI,CAAC,GAAG,IAAI,SAAJ,EAAR;AACA,QAAA,CAAC,CAAC,YAAF,GAAiB,CAAjB;AACA,QAAA,CAAC,CAAC,YAAF,GAAiB,CAAC,CAAC,cAAD,CAAlB;AACA,QAAA,CAAC,CAAC,QAAF,GAAa,CAAC,CAAC,UAAD,CAAd;AACA,QAAA,CAAC,CAAC,aAAF,GAAkB,CAAC,CAAC,eAAD,CAAnB;AACA,QAAA,CAAC,CAAC,kBAAF,GAAuB,CAAC,CAAC,oBAAD,CAAxB;AACA,QAAA,CAAC,CAAC,WAAF,GAAgB,CAAC,CAAC,aAAD,CAAjB;AACA,QAAA,CAAC,CAAC,gBAAF,GAAqB,CAAC,CAAC,kBAAD,CAAtB;AACA,QAAA,CAAC,CAAC,eAAF,GAAoB,CAAC,CAAC,iBAAD,CAArB;AACA,QAAA,KAAK,CAAC,IAAN,CAAW,CAAX;AACD,OAXD;AAYA,WAAK,QAAL,GAAgB,KAAhB;AACD,KAfiB,CAAlB;AAgBD;;AAEY,EAAA,SAAS,CAAC,EAAD,EAAwB;AAAA;;AAAA;AAC5C,MAAA,KAAI,CAAC,QAAL,GAAgB,EAAhB,CAD4C,CAE5C;;AACA,UAAI,KAAI,CAAC,WAAL,CAAiB,EAAE,CAAC,YAApB,CAAJ,EAAuC;AACrC;AACA,QAAA,KAAI,CAAC,WAAL,SAAyB,SAAS,CAAC,YAAV,CAAuB,YAAvB,CAAoC,KAAI,CAAC,gBAAzC,CAAzB;AACA,QAAA,KAAI,CAAC,OAAL,GAAe,IAAf,CAHqC,CAIrC;;AACA,QAAA,KAAI,CAAC,eAAL,CAAqB,EAArB,EALqC,CAMrC;;;AACA,QAAA,KAAI,CAAC,YAAL,GAAoB,CAApB;;AACA,QAAA,KAAI,CAAC,eAAL;AACD,OATD,MASO;AACL;AACA,QAAA,KAAI,CAAC,WAAL,GAAmB,IAAnB;AACA,QAAA,KAAI,CAAC,OAAL,GAAe,IAAf;AACD;AAhB2C;AAiB7C;;AAEM,EAAA,eAAe,GAAA;AACpB,IAAA,UAAU,CAAC,MAAK;AACd,WAAK,YAAL;;AACA,UAAI,KAAK,YAAL,IAAqB,EAAzB,EAA6B;AAC3B,YAAI,IAAI,GAAG,KAAX;;AACA,aAAK,IAAI,CAAC,GAAG,CAAb,EAAgB,CAAC,GAAG,KAAK,QAAL,CAAc,MAAlC,EAA0C,CAAC,EAA3C,EAA+C;AAC7C,cAAI,KAAK,QAAL,CAAc,CAAd,EAAiB,YAAjB,IAAiC,KAAK,QAAL,CAAc,YAAnD,EAAiE;AAC/D,gBAAI,KAAK,QAAL,CAAc,CAAd,EAAiB,YAAjB,IAAiC,KAArC,EAA4C;AAC1C,cAAA,IAAI,GAAG,IAAP;AACD;;AACD;AACD;AACF;;AACD,YAAI,CAAC,IAAL,EAAW;AACT,eAAK,eAAL;AACD;AACF,OAbD,MAaO;AACL,aAAK,UAAL;AACD;AACF,KAlBS,EAkBP,IAlBO,CAAV;AAmBD;;AAEM,EAAA,eAAe,CAAC,EAAD,EAAwB;AAC5C,QAAI,WAAW,GAAG,MAAM,CAAC,IAAI,IAAJ,EAAD,CAAxB;AACA,QAAI,GAAG,GAAG,IAAI,CAAC,KAAL,CAAW,YAAY,CAAC,OAAb,CAAqB,iBAArB,CAAX,CAAV;AACA,SAAK,EAAL,CAAQ,MAAR,CAAe,iBAAiB,EAAE,CAAC,YAAnC,EAAiD,MAAjD,CAAwD;AACtD,MAAA,aAAa,EAAE,WADuC;AAEtD,MAAA,QAAQ,EAAE,MAF4C;AAGtD,MAAA,YAAY,EAAE,MAHwC;AAItD,MAAA,WAAW,EAAE,GAJyC;AAKtD,MAAA,gBAAgB,EAAE,KAAK,iBAAL,CAAuB,GALa;AAMtD,MAAA,eAAe,EAAE,KAAK,eAAL,CAAqB;AANgB,KAAxD;AAQA,SAAK,EAAL,CAAQ,MAAR,CAAe,iBAAiB,GAAhC,EAAqC,MAArC,CAA4C;AAC1C,MAAA,aAAa,EAAE,WAD2B;AAE1C,MAAA,QAAQ,EAAE,MAFgC;AAG1C,MAAA,YAAY,EAAE,KAH4B;AAI1C,MAAA,WAAW,EAAE,UAJ6B;AAK1C,MAAA,gBAAgB,EAAE,UALwB;AAM1C,MAAA,eAAe,EAAE;AANyB,KAA5C;AAQD;;AAEM,EAAA,WAAW,CAAC,GAAD,EAAY;AAC5B,SAAK,IAAI,CAAC,GAAG,CAAb,EAAgB,CAAC,GAAG,KAAK,QAAL,CAAc,MAAlC,EAA0C,CAAC,EAA3C,EAA+C;AAC7C,UAAI,KAAK,QAAL,CAAc,CAAd,EAAiB,YAAjB,IAAiC,GAArC,EAA0C;AACxC,YAAI,KAAK,QAAL,CAAc,CAAd,EAAiB,QAAjB,IAA6B,MAAjC,EAAyC;AACvC,iBAAO,KAAP;AACD;;AACD;AACD;AACF;;AACD,WAAO,IAAP;AACD;;AAEM,EAAA,UAAU,GAAA;AACf,SAAK,eAAL,GAAuB,KAAvB;AACA,SAAK,WAAL,CAAiB,SAAjB,GAA6B,OAA7B,CAAqC,UAAU,KAAV,EAAe;AAClD,MAAA,KAAK,CAAC,OAAN,GAAgB,IAAhB;AACD,KAFD;AAGD;;AAEM,EAAA,QAAQ,GAAA;AACb,SAAK,eAAL,GAAuB,IAAvB;AACA,SAAK,WAAL,CAAiB,SAAjB,GAA6B,OAA7B,CAAqC,UAAU,KAAV,EAAe;AAClD,MAAA,KAAK,CAAC,OAAN,GAAgB,KAAhB;AACD,KAFD;AAGD;;AAEM,EAAA,KAAK,GAAA;AACV;AACA,SAAK,YAAL,GAAoB,EAApB;AACD;;AAEM,EAAA,UAAU,GAAA;AACf;AACA,SAAK,OAAL,GAAe,KAAf;AACA,SAAK,WAAL,CAAiB,SAAjB,GAA6B,OAA7B,CAAqC,UAAU,KAAV,EAAe;AAClD,MAAA,KAAK,CAAC,IAAN;AACD,KAFD;AAGA,SAAK,eAAL,GAAuB,KAAvB,CANe,CAOf;;AACA,SAAK,SAAL;AACD;;AAEM,EAAA,SAAS,GAAA;AACd,QAAI,GAAG,GAAG,IAAI,CAAC,KAAL,CAAW,YAAY,CAAC,OAAb,CAAqB,iBAArB,CAAX,CAAV;AACA,SAAK,EAAL,CAAQ,MAAR,CAAe,iBAAiB,KAAK,QAAL,CAAc,YAA9C,EAA4D,MAA5D,CAAmE;AACjE,MAAA,QAAQ,EAAE;AADuD,KAAnE;AAGA,SAAK,EAAL,CAAQ,MAAR,CAAe,iBAAiB,GAAhC,EAAqC,MAArC,CAA4C;AAC1C,MAAA,QAAQ,EAAE;AADgC,KAA5C;AAGD;;AAEM,EAAA,cAAc,GAAA;AACnB,SAAK,oBAAL,GAA4B,CAAC,KAAK,oBAAlC;AACD;;AAjL0B;;;mBAAhB,gB,EAAgB,EAAA,CAAA,QAAA,CAAA,EAAA,CAAA,mBAAA,C,EAAA,EAAA,CAAA,QAAA,CAAA,EAAA,CAAA,aAAA,C,EAAA,EAAA,CAAA,QAAA,CAAA,EAAA,CAAA,eAAA,C;AAAA,C;;;SAAhB,gB;AAAgB,EAAA,OAAA,EAAhB,gBAAgB,CAAA,I;AAAA,EAAA,UAAA,EAFf","sourcesContent":["import { MainPageService } from 'src/app/service/main-page/main-page.service';\r\nimport { MyNameService } from 'src/app/service/my-name/my-name.service';\r\nimport { ObjectChatThanhVien } from './../../../models/chat-page/chat-page-chat-page/header/object_chat_thanh_vien';\r\nimport { AngularFireDatabase } from '@angular/fire/database';\r\nimport { Subscription } from 'rxjs';\r\nimport { Injectable } from '@angular/core';\r\nimport { UserVideo } from 'src/app/models/chat-page/call-video/user-video';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CallVideoService {\r\n\r\n  // Request mediaDevices\r\n  public mediaConstraints = {\r\n    audio: true,\r\n    video: true\r\n  }\r\n\r\n  // localStream\r\n  public localStream: MediaStream;\r\n\r\n  // is show component call video\r\n  public is_show: boolean;\r\n\r\n  // Trạng thái camera bật hay tắt\r\n  public is_close_camera: boolean;\r\n  // Trạng thái my camera go to left\r\n  public is_camera_go_to_left: boolean;\r\n\r\n  // All user\r\n  public all_user: UserVideo[] = [];\r\n  // user đang tương tác\r\n  public now_user: ObjectChatThanhVien;\r\n  // request 45s\r\n  public countRequest = 0;\r\n\r\n  // service\r\n  public layAllUser: Subscription;\r\n\r\n  constructor(\r\n    private db: AngularFireDatabase,\r\n    private my_name_service: MyNameService,\r\n    private main_page_service: MainPageService\r\n  ) {\r\n    if (this.layAllUser == null) {\r\n      this.getData();\r\n    } else {\r\n      this.layAllUser.unsubscribe();\r\n      this.getData();\r\n    }\r\n  }\r\n\r\n  public getData() {\r\n    this.layAllUser = this.db.object(\"/call_video\").snapshotChanges().subscribe(data => {\r\n      let array: UserVideo[] = [];\r\n      Object.entries(data.payload.toJSON()).forEach(([k, v]) => {\r\n        let o = new UserVideo();\r\n        o.ma_tai_khoan = k;\r\n        o.bat_may_chua = v['bat_may_chua'];\r\n        o.goi_chua = v['goi_chua'];\r\n        o.thoi_gian_goi = v['thoi_gian_goi'];\r\n        o.thoi_gian_ket_thuc = v['thoi_gian_ket_thuc'];\r\n        o.tk_goi_minh = v['tk_goi_minh'];\r\n        o.hinh_tk_goi_minh = v['hinh_tk_goi_minh'];\r\n        o.ten_tk_goi_minh = v['ten_tk_goi_minh'];\r\n        array.push(o);\r\n      });\r\n      this.all_user = array;\r\n    })\r\n  }\r\n\r\n  public async callVideo(tk: ObjectChatThanhVien) {\r\n    this.now_user = tk;\r\n    // Check thử available\r\n    if (this.isAvailable(tk.ma_tai_khoan)) {\r\n      // Lấy video\r\n      this.localStream = await navigator.mediaDevices.getUserMedia(this.mediaConstraints);\r\n      this.is_show = true;\r\n      // Cập nhật lại trong firebase\r\n      this.writeToFirebase(tk);\r\n      // Time out 45s\r\n      this.countRequest = 0;\r\n      this.request45second();\r\n    } else {\r\n      // Lấy video\r\n      this.localStream = null;\r\n      this.is_show = true;\r\n    }\r\n  }\r\n\r\n  public request45second() {\r\n    setTimeout(() => {\r\n      this.countRequest++;\r\n      if (this.countRequest <= 45) {\r\n        let isOk = false;\r\n        for (let i = 0; i < this.all_user.length; i++) {\r\n          if (this.all_user[i].ma_tai_khoan == this.now_user.ma_tai_khoan) {\r\n            if (this.all_user[i].bat_may_chua == 'roi') {\r\n              isOk = true;\r\n            }\r\n            break;\r\n          }\r\n        }\r\n        if (!isOk) {\r\n          this.request45second();\r\n        }\r\n      } else {\r\n        this.cuocGoiNho();\r\n      }\r\n    }, 1000);\r\n  }\r\n\r\n  public writeToFirebase(tk: ObjectChatThanhVien) {\r\n    let currentTime = Number(new Date());\r\n    let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn\"));\r\n    this.db.object(\"/call_video/\" + tk.ma_tai_khoan).update({\r\n      thoi_gian_goi: currentTime,\r\n      goi_chua: \"dang\",\r\n      bat_may_chua: \"chua\",\r\n      tk_goi_minh: mtk,\r\n      hinh_tk_goi_minh: this.main_page_service.img,\r\n      ten_tk_goi_minh: this.my_name_service.myName\r\n    });\r\n    this.db.object(\"/call_video/\" + mtk).update({\r\n      thoi_gian_goi: currentTime,\r\n      goi_chua: \"dang\",\r\n      bat_may_chua: \"roi\",\r\n      tk_goi_minh: 'khong_co',\r\n      hinh_tk_goi_minh: 'khong_co',\r\n      ten_tk_goi_minh: 'khong_co'\r\n    });\r\n  }\r\n\r\n  public isAvailable(mtk: string): boolean {\r\n    for (let i = 0; i < this.all_user.length; i++) {\r\n      if (this.all_user[i].ma_tai_khoan == mtk) {\r\n        if (this.all_user[i].goi_chua == 'dang') {\r\n          return false;\r\n        }\r\n        break;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public startVideo() {\r\n    this.is_close_camera = false\r\n    this.localStream.getTracks().forEach(function (track) {\r\n      track.enabled = true;\r\n    });\r\n  }\r\n\r\n  public offVideo() {\r\n    this.is_close_camera = true;\r\n    this.localStream.getTracks().forEach(function (track) {\r\n      track.enabled = false;\r\n    });\r\n  }\r\n\r\n  public close() {\r\n    // countRequest\r\n    this.countRequest = 45;\r\n  }\r\n\r\n  public cuocGoiNho() {\r\n    // view\r\n    this.is_show = false;\r\n    this.localStream.getTracks().forEach(function (track) {\r\n      track.stop();\r\n    });\r\n    this.is_close_camera = false;\r\n    // data\r\n    this.closeData();\r\n  }\r\n\r\n  public closeData() {\r\n    let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn\"));\r\n    this.db.object(\"/call_video/\" + this.now_user.ma_tai_khoan).update({\r\n      goi_chua: \"chua\",\r\n    });\r\n    this.db.object(\"/call_video/\" + mtk).update({\r\n      goi_chua: \"chua\",\r\n    });\r\n  }\r\n\r\n  public cameraGoToLeft() {\r\n    this.is_camera_go_to_left = !this.is_camera_go_to_left;\r\n  }\r\n\r\n}\r\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}