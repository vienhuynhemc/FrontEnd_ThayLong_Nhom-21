{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/Administrator/Desktop/FrontEnd_ThayLong_Nhom-21/app-chat/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport { finalize } from 'rxjs/operators';\nimport { ObjectChatContentWS } from 'src/app/models/ws/chat-page/chat-page-chat-page/content/object_chat_content_ws';\nimport { ObjectDangNhapWS } from 'src/app/models/ws/chat-page/chat-page-chat-page/content/object_dang_nhap_ws';\nimport { CamXucTinNhanWS } from 'src/app/models/ws/chat-page/chat-page-chat-page/content/select-emoji/cam_xuc_tin_nhan_ws';\nimport { ChatPageCuocTroChuyenWS } from 'src/app/models/ws/chat-page/chat-page-friends-page/chat_page_cuoc_tro_chuyen_ws';\nimport { ChatPageObjectTinNhanFriendWS } from 'src/app/models/ws/chat-page/chat-page-friends-page/chat_page_object_tin_nhan_friend_ws';\nimport { ChatPageTinhTrangXemWS } from 'src/app/models/ws/chat-page/chat-page-friends-page/chat_page_tinh_trang_xem_ws';\nimport { ChatPageTinNhanWS } from 'src/app/models/ws/chat-page/chat-page-friends-page/chat_page_tin_nhan_ws';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/fire/database\";\nimport * as i2 from \"@angular/platform-browser\";\nimport * as i3 from \"@angular/fire/storage\";\nimport * as i4 from \"../../../my-name/my-name-ws.service\";\nimport * as i5 from \"./chat-page-content-websocket.service\";\nexport class ChatPageChatPageContentWsService {\n  constructor(db, // pipi html\n  sanitized, storage, my_name_service, chat_page_content_websocket) {\n    this.db = db;\n    this.sanitized = sanitized;\n    this.storage = storage;\n    this.my_name_service = my_name_service;\n    this.chat_page_content_websocket = chat_page_content_websocket; // tin nhắn lấy từ websocket\n\n    this.messagesWebsocket = []; // kiểm tra load lần đầu websocket\n\n    this.checkLoadMessageWS = false; // service\n    // tin nhan\n\n    this.tin_nhans = [];\n    this.object_chat = new ObjectChatContentWS();\n    this.object_chat.cuoc_tro_truyen = new ChatPageCuocTroChuyenWS();\n    this.dang_nhaps = []; // Hàm update lại ban_bes 5s 1 lần\n\n    this.update(); // Hàm cập nhật đang nhập 3s 1 lần\n\n    this.updateDangNhap();\n  }\n\n  updateOnInput(id) {\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\n    let hinh = \"\";\n    let ten = \"\";\n\n    if (this.object_chat.thanh_vien != null) {\n      for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\n        if (this.object_chat.thanh_vien[i].ma_tai_khoan == ma_tai_khoan) {\n          hinh = this.object_chat.thanh_vien[i].link_hinh_dai_dien;\n          ten = this.object_chat.thanh_vien[i].ten_da_duoc_xu_ly;\n          break;\n        }\n      }\n    }\n\n    setTimeout(() => {\n      let current = Number(new Date());\n      this.db.object(\"/trang_thai_dang_nhap_ws/\" + id + \"/\" + ma_tai_khoan).update({\n        lan_cuoi_dang_nhap: current,\n        hinh: hinh,\n        ten: ten\n      });\n\n      if (this.onInput) {\n        this.updateOnInput(id);\n      }\n    }, 2500);\n  }\n\n  getDangNhap(id) {\n    return this.db.object(\"/trang_thai_dang_nhap_ws/\" + id).snapshotChanges();\n  }\n\n  dienThongTinDangNhap(object) {\n    if (object != null) {\n      let array = [];\n      let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\n      Object.entries(object).forEach(([ma_thanh_vien, data_thanh_vien]) => {\n        if (ma_thanh_vien != ma_tai_khoan) {\n          let o = new ObjectDangNhapWS();\n          o.ma_tai_khoan = ma_thanh_vien;\n          o.lan_cuoi_dang_nhap = data_thanh_vien['lan_cuoi_dang_nhap'];\n          o.hinh = data_thanh_vien['hinh'];\n          o.ten = data_thanh_vien['ten'];\n          array.push(o);\n        }\n      }); // Xem thử ông nào quá 2s thì xóa\n      // ông nào rời nhóm rồi cũng xóa\n\n      let currentTime = Number(new Date());\n      let count = 0;\n\n      while (count < array.length) {\n        if (currentTime - array[count].lan_cuoi_dang_nhap > 2000 || this.object_chat.checkRoiChua(array[count].ma_tai_khoan)) {\n          array.splice(count, 1);\n        } else {\n          array[count].getNoiDung();\n          count++;\n        }\n      }\n\n      this.dang_nhaps = array;\n    }\n  }\n\n  updateDangNhap() {\n    setTimeout(() => {\n      // Xem thử ông nào quá 2s thì xóa\n      let currentTime = Number(new Date());\n      let count = 0;\n\n      while (count < this.dang_nhaps.length) {\n        if (currentTime - this.dang_nhaps[count].lan_cuoi_dang_nhap > 2000) {\n          this.dang_nhaps.splice(count, 1);\n        } else {\n          count++;\n        }\n      }\n\n      this.updateDangNhap();\n    }, 3000);\n  }\n\n  update() {\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\n    setTimeout(() => {\n      // Kiểm tra online\n      let currentTime = Number(new Date());\n\n      if (this.object_chat != null) {\n        let isOnline = false;\n\n        if (this.object_chat.thanh_vien != null) {\n          for (let j = 0; j < this.object_chat.thanh_vien.length; j++) {\n            if (this.object_chat.thanh_vien[j].ma_tai_khoan != ma_tai_khoan) {\n              this.db.database.ref('cai_dat_ws').child(this.object_chat.thanh_vien[j].ma_tai_khoan).on('value', set => {\n                if (set.val().trang_thai_hoat_dong == 'tat') isOnline = false;else {\n                  if (this.object_chat.cuoc_tro_truyen.loai_cuoc_tro_truyen == 'nhom') {\n                    if (this.object_chat.thanh_vien[j].roi_chua == 'chua') {\n                      let last_time = this.object_chat.thanh_vien[j].lan_cuoi_dang_nhap;\n                      let overTime = currentTime - last_time;\n\n                      if (overTime < 10000) {\n                        isOnline = true;\n                      }\n                    }\n                  } else {\n                    let last_time = this.object_chat.thanh_vien[j].lan_cuoi_dang_nhap;\n                    let overTime = currentTime - last_time;\n\n                    if (overTime < 10000) {\n                      isOnline = true;\n                    }\n                  }\n                }\n              });\n              if (isOnline) break;\n            }\n          }\n        }\n\n        this.object_chat.is_online = isOnline;\n      }\n\n      this.update();\n    }, 5000);\n  }\n\n  sumitTinNhan(ma_cuoc_tro_chuyen, tin_nhan, loai, ten) {\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\n    let currentTime = Number(new Date()); // Tin nhắn\n\n    this.db.list(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen).push({\n      dia_chi_file: \"\",\n      link_file: \"\",\n      loai_tin_nhan: loai,\n      [\"ma_tai_khoan\"]: ma_tai_khoan,\n      ten: ten,\n      ma_tin_nhan_phan_hoi: \"\",\n      ngay_gui: currentTime,\n      noi_dung: tin_nhan\n    }).then(ref => {\n      // Lấy all thành viên\n      let array = [];\n      array.push({\n        ma_tai_khoan: ma_tai_khoan,\n        ngay_nhan: 0,\n        ngay_xem: currentTime,\n        xem_chua: \"roi\",\n        ten: ten\n      });\n\n      for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\n        array.push({\n          ma_tai_khoan: this.object_chat.thanh_vien[i].ma_tai_khoan,\n          ngay_nhan: 0,\n          ngay_xem: 0,\n          xem_chua: \"chua\",\n          ten: this.object_chat.thanh_vien[i].ten\n        });\n      }\n\n      for (let i = 0; i < array.length; i++) {\n        this.db.object(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen + \"/\" + ref.key + \"/tinh_trang_xem/\" + array[i]['ma_tai_khoan']).update({\n          ngay_nhan: array[i]['ngay_nhan'],\n          ngay_xem: array[i]['ngay_xem'],\n          xem_chua: array[i]['xem_chua'],\n          ten: array[i]['ten']\n        });\n      }\n\n      ; // gửi tin nhắn websocket\n\n      this.submitMessageWebsocket(ma_cuoc_tro_chuyen, ref.key);\n    });\n    ;\n  }\n\n  sumitTinNhanThongBaoTaoNhom(ma_cuoc_tro_chuyen, tin_nhan, loai, ten) {\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\n    let currentTime = Number(new Date()); // Tin nhắn\n\n    this.db.list(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen).push({\n      dia_chi_file: \"\",\n      link_file: \"\",\n      loai_tin_nhan: loai,\n      [\"ma_tai_khoan\"]: ma_tai_khoan,\n      ten: ten,\n      ma_tin_nhan_phan_hoi: \"\",\n      ngay_gui: currentTime,\n      noi_dung: tin_nhan\n    }).then(ref => {\n      // Lấy all thành viên\n      let array = [];\n      array.push({\n        ma_tai_khoan: ma_tai_khoan,\n        ngay_nhan: 0,\n        ngay_xem: currentTime,\n        xem_chua: \"roi\",\n        ten: ten\n      });\n\n      for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\n        array.push({\n          ma_tai_khoan: this.object_chat.thanh_vien[i].ma_tai_khoan,\n          ngay_nhan: 0,\n          ngay_xem: 0,\n          xem_chua: \"chua\",\n          ten: this.object_chat.thanh_vien[i].ten\n        });\n      }\n\n      for (let i = 0; i < array.length; i++) {\n        this.db.object(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen + \"/\" + ref.key + \"/tinh_trang_xem/\" + array[i]['ma_tai_khoan']).update({\n          ngay_nhan: array[i]['ngay_nhan'],\n          ngay_xem: array[i]['ngay_xem'],\n          xem_chua: array[i]['xem_chua'],\n          ten: array[i]['ten']\n        });\n      }\n\n      ; // gửi tin nhắn websocket\n\n      this.submitMessageWebsocket(ma_cuoc_tro_chuyen, ref.key);\n    });\n  }\n\n  sumitTinNhanBTCX(ma_cuoc_tro_chuyen, tin_nhan, loai, ten, alt) {\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\n    let currentTime = Number(new Date()); // Tin nhắn\n\n    this.db.list(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen).push({\n      dia_chi_file: \"\",\n      link_file: \"\",\n      loai_tin_nhan: loai,\n      [\"ma_tai_khoan\"]: ma_tai_khoan,\n      ten: ten,\n      ma_tin_nhan_phan_hoi: \"\",\n      ngay_gui: currentTime,\n      noi_dung: tin_nhan,\n      alt: alt\n    }).then(ref => {\n      // Lấy all thành viên\n      let array = [];\n      array.push({\n        ma_tai_khoan: ma_tai_khoan,\n        ngay_nhan: 0,\n        ngay_xem: currentTime,\n        xem_chua: \"roi\",\n        ten: ten\n      });\n\n      for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\n        array.push({\n          ma_tai_khoan: this.object_chat.thanh_vien[i].ma_tai_khoan,\n          ngay_nhan: 0,\n          ngay_xem: 0,\n          xem_chua: \"chua\",\n          ten: this.object_chat.thanh_vien[i].ten\n        });\n      }\n\n      for (let i = 0; i < array.length; i++) {\n        this.db.object(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen + \"/\" + ref.key + \"/tinh_trang_xem/\" + array[i]['ma_tai_khoan']).update({\n          ngay_nhan: array[i]['ngay_nhan'],\n          ngay_xem: array[i]['ngay_xem'],\n          xem_chua: array[i]['xem_chua'],\n          ten: array[i]['ten']\n        });\n      }\n\n      ; // gửi tin nhắn websocket\n\n      this.submitMessageWebsocket(ma_cuoc_tro_chuyen, ref.key);\n    });\n  }\n\n  getBanBe() {\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\n    return this.db.object(\"/ban_be_ws/\" + ma_tai_khoan).snapshotChanges();\n  }\n\n  layBanBe(object) {\n    let ban_bes = [];\n\n    if (object != null) {\n      Object.entries(object).forEach(([ma_thanh_vien, data_thanh_vien]) => {\n        if (data_thanh_vien['ton_tai'] == 0) {\n          ban_bes.push(ma_thanh_vien);\n        }\n      });\n    }\n\n    this.ban_bes = ban_bes;\n  }\n\n  dienThongTinCoBan(object) {\n    if (object != null) {\n      this.object_chat.cuoc_tro_truyen.loai_cuoc_tro_truyen = object['loai_cuoc_tro_truyen'];\n      this.object_chat.cuoc_tro_truyen.mau = object['mau'];\n      this.object_chat.cuoc_tro_truyen.mau_tren = object['mau_tren'];\n      this.object_chat.cuoc_tro_truyen.mau_duoi = object['duoi'];\n      this.object_chat.cuoc_tro_truyen.bieu_tuong_cam_xuc = object['bieu_tuong_cam_xuc'];\n\n      if (this.object_chat.cuoc_tro_truyen.mau == '#3275f7') {\n        this.object_chat.cuoc_tro_truyen.mau = 'linear-gradient(0deg,#3275f7, #3275f7)';\n        this.object_chat.cuoc_tro_truyen.mau_tren = \"#3275f7\";\n        this.object_chat.cuoc_tro_truyen.mau_duoi = \"#3275f7\";\n      }\n    }\n  }\n\n  getObjectChat(ma_cuoc_tro_chuyen) {\n    return this.db.object(\"/cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen).snapshotChanges();\n  }\n\n  getObjectChatThanhVien(ma_cuoc_tro_chuyen) {\n    return this.db.object(\"/thanh_vien_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen).snapshotChanges();\n  }\n\n  getThongTinTroChuyenNhom(ma_cuoc_tro_chuyen) {\n    return this.db.object(\"/thong_tin_tro_chuyen_nhom_ws/\" + ma_cuoc_tro_chuyen).snapshotChanges();\n  }\n\n  dienThongTinNhom(object) {\n    if (object != null) {\n      if (object['ton_tai'] == 0) {\n        this.object_chat.cuoc_tro_truyen.ten_nhom = object['ten-nhom'];\n        this.object_chat.cuoc_tro_truyen.ma_tai_khoan_chu_so_huu = object['chu_so_huu'];\n        this.object_chat.cuoc_tro_truyen.ngay_tao = object['ngay_tao'];\n        this.object_chat.cuoc_tro_truyen.ton_tai = object['ton_tai'];\n      }\n    } else {\n      this.object_chat.cuoc_tro_truyen.ten_nhom = null;\n      this.object_chat.cuoc_tro_truyen.ma_tai_khoan_chu_so_huu = null;\n      this.object_chat.cuoc_tro_truyen.ngay_tao = null;\n      this.object_chat.cuoc_tro_truyen.ton_tai = null;\n    }\n  }\n\n  dienThanhVien(object) {\n    let array = [];\n\n    if (object != null) {\n      Object.entries(object).forEach(([ma_thanh_vien, data_thanh_vien]) => {\n        let objectChatThanhVien = new ChatPageObjectTinNhanFriendWS();\n        objectChatThanhVien.ma_tai_khoan = ma_thanh_vien;\n        objectChatThanhVien.ngay_tham_gia = data_thanh_vien['ngay_tham_gia'];\n        objectChatThanhVien.trang_thai = data_thanh_vien['trang_thai'];\n        objectChatThanhVien.roi_chua = data_thanh_vien['roi_chua'];\n        objectChatThanhVien.ngay_roi_di = data_thanh_vien['ngay_roi_di'];\n        array.push(objectChatThanhVien);\n      });\n    }\n\n    this.object_chat.thanh_vien = array; // Có được thành viên kiểm tra rời chưa\n\n    this.object_chat.getIsRoiChua();\n  }\n\n  getDataThanhVien() {\n    return this.db.object(\"/tai_khoan_ws\").snapshotChanges();\n  }\n\n  dienThongTinThanhVien(object) {\n    Object.entries(object).forEach(([ma_thanh_vien, data_thanh_vien]) => {\n      for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\n        if (this.object_chat.thanh_vien[i].ma_tai_khoan == ma_thanh_vien) {\n          this.object_chat.thanh_vien[i].link_hinh_dai_dien = data_thanh_vien['link_hinh'];\n          this.object_chat.thanh_vien[i].ten = data_thanh_vien['ten']; // Có tên rồi thì getName cho chính bản thân nó\n\n          this.object_chat.thanh_vien[i].getName(); // Có tên rồi thì lấy status connect để đổ ra cho đỡ lag\n\n          this.object_chat.getCreateFriends(this.ban_bes);\n        }\n      }\n    }); // Điền thông tin thành viên xong thì get img để đổ ra cho bớt lag\n\n    this.object_chat.getImgAvatars();\n  }\n\n  dienLanCUoiOnline(object) {\n    let count = 0;\n    Object.entries(object).forEach(([ma_thanh_vien, data_thanh_vien]) => {\n      for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\n        if (this.object_chat.thanh_vien[i].ma_tai_khoan == ma_thanh_vien) {\n          this.object_chat.thanh_vien[i].lan_cuoi_dang_nhap = data_thanh_vien['lan_cuoi_dang_nhap'];\n          count++;\n          break;\n        }\n      }\n    });\n\n    if (count != this.object_chat.thanh_vien.length) {\n      for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\n        if (this.object_chat.thanh_vien[i].lan_cuoi_dang_nhap == null) {\n          this.object_chat.thanh_vien[i].lan_cuoi_dang_nhap = 0;\n        }\n      }\n    }\n  }\n\n  getLanCuoiOnline() {\n    return this.db.object(\"/lan_cuoi_dang_nhap_ws\").snapshotChanges();\n  }\n\n  getTinNhan(id) {\n    return this.db.object(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + id).snapshotChanges();\n  } // get tin nhắn từ websocket\n\n\n  dienTinNhanWebSocket(valueFire, ma_cuoc_tro_chuyen, page) {\n    var _this = this;\n\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\")); // gửi tin nhắn 1 : 1\n\n    if (this.object_chat.cuoc_tro_truyen.loai_cuoc_tro_truyen == 'don') {\n      this.db.database.ref('thanh_vien_cuoc_tro_chuyen_ws').child(ma_cuoc_tro_chuyen).once('value', members => {\n        members.forEach(eleMember => {\n          if (eleMember.key != ma_tai_khoan) {\n            this.db.database.ref('tai_khoan_ws').child(eleMember.key).once('value', infor => {\n              this.chat_page_content_websocket.getMessagesPeople(infor.val().email, page);\n            });\n          }\n        });\n      }); // gửi tin nhắn nhóm\n    } else {\n      this.db.database.ref('thong_tin_tro_chuyen_nhom_ws').child(ma_cuoc_tro_chuyen).once('value', group => {\n        this.chat_page_content_websocket.getMessagesGroup(group.val().ten_nhom, page);\n      });\n    } // dùng asysc/await để bất động bộ chờ dữ liệu từ serve gửi về :3\n\n\n    this.chat_page_content_websocket.messages_list.subscribe( /*#__PURE__*/function () {\n      var _ref = _asyncToGenerator(function* (data) {\n        let value = yield JSON.parse(JSON.stringify(data));\n\n        if (_this.object_chat.cuoc_tro_truyen.loai_cuoc_tro_truyen == 'don') {\n          // nếu là get tất cả tin nhắn\n          if (value.status == \"success\") {\n            if ((yield value.data.id) === undefined) {\n              console.log(yield value.data.length);\n              yield value.data.forEach(message => {\n                if (!_this.messagesWebsocket.includes(message.mes)) _this.messagesWebsocket.push(message.mes);\n              }); // nếu là nhận tin nhắn từ người khác\n            } else {\n              if (yield !_this.messagesWebsocket.includes(value.data.mes)) _this.messagesWebsocket.push(value.data.mes);\n            }\n\n            yield _this.dienTinNhan(valueFire, ma_cuoc_tro_chuyen); // đệ quy để lấy ra tất cả tin nhắn\n\n            if ((yield value.data.length) >= 50 && !_this.checkLoadMessageWS) {\n              _this.dienTinNhanWebSocket(valueFire, ma_cuoc_tro_chuyen, page + 1);\n            } else {\n              _this.checkLoadMessageWS = true;\n            }\n          }\n        }\n      });\n\n      return function (_x) {\n        return _ref.apply(this, arguments);\n      };\n    }());\n  }\n\n  dienTinNhan(value, maCuocTroChuyen) {\n    // let tin_nhans: ChatPageTinNhanWS[] = [];\n    if (value != null) {\n      Object.entries(value).forEach(([ma_tin_nhan, data_tin_nhan]) => {\n        if (this.messagesWebsocket.includes(ma_tin_nhan)) {\n          let tin_nhan = new ChatPageTinNhanWS();\n          tin_nhan.ma_tin_nhan = ma_tin_nhan;\n          tin_nhan.dia_chi_file = data_tin_nhan['dia_chi_file'];\n          tin_nhan.link_file = data_tin_nhan['link_file'];\n          tin_nhan.loai_tin_nhan = data_tin_nhan['loai_tin_nhan'];\n          tin_nhan.ma_tai_khoan = data_tin_nhan['ma_tai_khoan'];\n          tin_nhan.ma_tin_nhan_phan_hoi = data_tin_nhan['ma_tin_nhan_phan_hoi'];\n          tin_nhan.ngay_gui = data_tin_nhan['ngay_gui'];\n          tin_nhan.ngay_thu_hoi = data_tin_nhan['ngay_thu_hoi'];\n          tin_nhan.noi_dung = data_tin_nhan['noi_dung'];\n          tin_nhan.ten = data_tin_nhan['ten'];\n\n          if (tin_nhan.loai_tin_nhan == 'gui_hinh') {\n            tin_nhan.danh_sach_url_anh = [];\n            this.accessluu_fileFireStorage(maCuocTroChuyen, tin_nhan.noi_dung).listAll().then(result => {\n              result.items.forEach(element => {\n                element.getDownloadURL().then(url => {\n                  tin_nhan.danh_sach_url_anh.push(url);\n                });\n              });\n            });\n          } // Tình trạng xem\n\n\n          let tinhTrangXem = data_tin_nhan['tinh_trang_xem'];\n          let tinh_trang_xems = [];\n\n          if (tinhTrangXem != null) {\n            Object.entries(tinhTrangXem).forEach(([ma_tai_khoan, data]) => {\n              let o = new ChatPageTinhTrangXemWS();\n              o.ma_tai_khoan = ma_tai_khoan;\n              o.ngay_xem = data['ngay_xem'];\n              o.xem_chua = data['xem_chua'];\n              o.ngay_nhan = data['ngay_nhan'];\n              o.ten = data['ten'];\n              o.is_roi_chua = this.taiKhoanTinhTrangXemRoiChua(o.ma_tai_khoan);\n              o.getNoiDung();\n              tinh_trang_xems.push(o);\n            });\n            tin_nhan.tinh_trang_xem = tinh_trang_xems; // Oke h làm một số chuyện trc cho đỡ lag\n            // Nếu là loại thông báo thì get Noi dung thong bao\n\n            if (tin_nhan.loai_tin_nhan == 'thong_bao') {\n              tin_nhan.getNoiDungThongBao();\n            } // Kiểm tra có phải là bản thân ko\n\n\n            tin_nhan.getIsBanThan(); // Lấy thời gian của tin nhắn\n\n            tin_nhan.getTime(); // Lấy tình trạng đã gửi\n\n            tin_nhan.getIsDaGui(); // Lấy tình trạng đã chuyển\n\n            tin_nhan.getIsDaChuyen(); // Lấy tình trạng có người xem\n\n            tin_nhan.getIsCoNguoiXem(); // Lấy tên đã được sử lý\n\n            tin_nhan.getTen(); // Lấy nội dung html\n\n            tin_nhan.getNoiDungHTMLTinNhan(this.sanitized); // Emoji\n\n            let cam_xuc_tin_nhan = data_tin_nhan['cam_xuc_tin_nhan'];\n            let camXucs = [];\n\n            if (cam_xuc_tin_nhan != null) {\n              Object.entries(cam_xuc_tin_nhan).forEach(([k, v]) => {\n                let cx = new CamXucTinNhanWS();\n                cx.ma_tai_khoan = k;\n                cx.ten = v['ten'];\n                cx.loai_cam_xuc = v['loai'];\n                cx.url = v['url'];\n                camXucs.push(cx);\n              });\n              tin_nhan.cam_xuc_tin_nhan = camXucs; // is exits dscx\n\n              tin_nhan.getIsExitsDSCX(); // tooltip p\n\n              tin_nhan.getToolTipP(); // exits all\n\n              tin_nhan.getIsExitsCX();\n            }\n\n            let checkAdd = false;\n            this.tin_nhans.forEach(element => {\n              if (element.ma_tin_nhan == tin_nhan.ma_tin_nhan) checkAdd = true;\n            });\n            !checkAdd ? this.tin_nhans.push(tin_nhan) : '';\n          }\n        }\n      });\n    } // Xem ông nào đang bật biểu tưởng cảm xúc thì bật ổng dậy\n    // Rồi gán lại tin nhắn mới\n\n\n    this.handleOpenSelectEmojiAndUpdate(this.tin_nhans); // Lọc lại tin nhắn lấy những tin nhắn trước thời gian ta đã rời đi\n\n    if (this.object_chat.is_roi_chua) {\n      this.fillter();\n    } // Có được list tin nhắn hoàn thiện ta tính số người đã xem được ở từng tin nhắn\n\n\n    for (let i = 0; i < this.object_chat.cuoc_tro_truyen.tin_nhan.length; i++) {\n      this.object_chat.cuoc_tro_truyen.tin_nhan[i].getSoNguoiXemDangOViTriTinNhanNay(i, this.object_chat.cuoc_tro_truyen.tin_nhan);\n    } // Sau đó tạo các tin nhắn thời gian kèm cặp vào cách nhau 15p\n\n\n    this.addTimeSpace(); // Tính margin và border\n\n    this.handleBorderAndMargin();\n  }\n\n  handleOpenSelectEmojiAndUpdate(tin_nhans) {\n    let mtks = null;\n\n    if (this.object_chat.cuoc_tro_truyen.tin_nhan != null && this.object_chat.cuoc_tro_truyen.tin_nhan.length > 0) {\n      for (let i = 0; i < this.object_chat.cuoc_tro_truyen.tin_nhan.length; i++) {\n        if (this.object_chat.cuoc_tro_truyen.tin_nhan[i].is_show_select_emoji) {\n          mtks = this.object_chat.cuoc_tro_truyen.tin_nhan[i].ma_tin_nhan;\n          break;\n        }\n      }\n    }\n\n    if (mtks != null) {\n      for (let i = 0; i < tin_nhans.length; i++) {\n        if (tin_nhans[i].ma_tin_nhan == mtks) {\n          tin_nhans[i].is_show_select_emoji = true;\n          break;\n        }\n      }\n    }\n\n    this.object_chat.cuoc_tro_truyen.tin_nhan = tin_nhans;\n  }\n\n  taiKhoanTinhTrangXemRoiChua(mtk) {\n    for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\n      if (this.object_chat.thanh_vien[i].ma_tai_khoan == mtk) {\n        if (this.object_chat.thanh_vien[i].roi_chua == 'roi') {\n          return true;\n        }\n      }\n    }\n\n    return false;\n  }\n\n  fillter() {\n    let i = this.object_chat.cuoc_tro_truyen.tin_nhan.length - 1;\n    let timeRoiDi = this.object_chat.time_roi_di;\n\n    while (i > -1) {\n      if (this.object_chat.cuoc_tro_truyen.tin_nhan[i].ngay_gui > timeRoiDi) {\n        this.object_chat.cuoc_tro_truyen.tin_nhan.splice(i, 1);\n        i--;\n      } else {\n        break;\n      }\n    }\n  }\n\n  handleBorderAndMargin() {\n    let count = 0;\n\n    for (let i = 0; i < this.object_chat.cuoc_tro_truyen.tin_nhan.length; i++) {\n      // Tính xem nó có border top va bottom ko\n      // Thằng đầu tiên có border top\n      if (count == 0) {\n        this.object_chat.cuoc_tro_truyen.tin_nhan[i].isHaveBorderTop = true;\n      } else {\n        this.object_chat.cuoc_tro_truyen.tin_nhan[i].getIsHaveBorderTop(this.object_chat.cuoc_tro_truyen.tin_nhan[count - 1]);\n      } // Kiểm tra borderbottom\n\n\n      if (count > 0) {\n        this.object_chat.cuoc_tro_truyen.tin_nhan[count - 1].getIsHaveBorderBottom(this.object_chat.cuoc_tro_truyen.tin_nhan[i]);\n      } // Tính margin top cho tin nhắn\n      // Thằng đàu tiên luôn margin top 0px\n\n\n      if (count == 0) {\n        this.object_chat.cuoc_tro_truyen.tin_nhan[i].marginTop = \"0px\";\n      } else {\n        this.object_chat.cuoc_tro_truyen.tin_nhan[i].getMarginTopTinNhan(this.object_chat.cuoc_tro_truyen.tin_nhan[count - 1]);\n      }\n\n      count++;\n    } // Thằng cuối cùng sẽ có border bottom\n\n\n    if (count > 0) {\n      this.object_chat.cuoc_tro_truyen.tin_nhan[count - 1].isHaveBorderBottom = true;\n    }\n  }\n\n  addTimeSpace() {\n    let i = 0; // Thời gian hiện tại\n\n    let nowTime = 0;\n\n    while (i < this.object_chat.cuoc_tro_truyen.tin_nhan.length) {\n      let time = this.object_chat.cuoc_tro_truyen.tin_nhan[i].ngay_gui; // > 15 minutes?\n\n      if (time - nowTime > 15 * 60000) {\n        let object = new ChatPageTinNhanWS();\n        object.noi_dung = this.getTimeSpaceString(time);\n        object.loai_tin_nhan = 'thoi_gian';\n        nowTime = time;\n        this.object_chat.cuoc_tro_truyen.tin_nhan.splice(i, 0, object);\n        i += 2;\n      } else {\n        i++;\n      }\n    }\n  }\n\n  getTimeSpaceString(time) {\n    let date = new Date(time);\n    let year = date.getFullYear();\n    let thang = date.getMonth() + 1;\n    let ngay = date.getDate();\n    let gio = date.getHours();\n    let phut = date.getMinutes();\n    return `${gio.toString().length > 1 ? gio : \"0\" + gio}:${phut.toString().length > 1 ? phut : \"0\" + phut}, ${ngay.toString().length > 1 ? ngay : \"0\" + ngay} Tháng ${thang.toString().length > 1 ? thang : \"0\" + thang}, ${year}`;\n  } // lưu image vào lưu_file trong storage firebase\n\n\n  saveImageluu_fileInStorage(image, idConversation, keyImage) {\n    let filePath = '/luu_file_ws/' + idConversation + \"/\" + keyImage + '/';\n    let newKey = Number(new Date());\n    let ref = this.storage.ref(filePath + newKey + image.file.name).put(image.file);\n    return ref;\n  } // save file vao storage firebase\n\n\n  saveFileluu_fileStorage(file, idConversation, newKey, typeFile) {\n    let filePath = '/luu_file_ws/' + idConversation + \"/\";\n    let ref = this.storage.ref(filePath + newKey + file.file.name).put(file.file);\n    let check100Percent = false;\n    ref.percentageChanges().subscribe(percent => {\n      if (percent == 100) {\n        ref.snapshotChanges().pipe(finalize(() => {\n          this.storage.ref(filePath + newKey + file.file.name).getDownloadURL().subscribe(downloadURL => {\n            if (!check100Percent) {\n              this.submitMessageFile(idConversation, downloadURL, typeFile, this.my_name_service.myName, file.name);\n              check100Percent = true;\n            }\n          });\n        })).subscribe();\n      }\n    });\n  } // lưu link image vao danh sach file trong db\n\n\n  submitMessageFile(ma_cuoc_tro_chuyen, tin_nhan, loai, ten, tenFile) {\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\n    let currentTime = Number(new Date()); // Tin nhắn\n\n    this.db.list(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen).push({\n      dia_chi_file: \"\",\n      // xet link file la ten file\n      link_file: tenFile,\n      loai_tin_nhan: loai,\n      [\"ma_tai_khoan\"]: ma_tai_khoan,\n      ten: ten,\n      ma_tin_nhan_phan_hoi: \"\",\n      ngay_gui: currentTime,\n      noi_dung: tin_nhan\n    }).then(ref => {\n      // Lấy all thành viên\n      let array = [];\n      array.push({\n        ma_tai_khoan: ma_tai_khoan,\n        ngay_nhan: 0,\n        ngay_xem: currentTime,\n        xem_chua: \"roi\",\n        ten: ten\n      });\n\n      for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\n        array.push({\n          ma_tai_khoan: this.object_chat.thanh_vien[i].ma_tai_khoan,\n          ngay_nhan: 0,\n          ngay_xem: 0,\n          xem_chua: \"chua\",\n          ten: this.object_chat.thanh_vien[i].ten\n        });\n      }\n\n      for (let i = 0; i < array.length; i++) {\n        this.db.object(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen + \"/\" + ref.key + \"/tinh_trang_xem/\" + array[i]['ma_tai_khoan']).update({\n          ngay_nhan: array[i]['ngay_nhan'],\n          ngay_xem: array[i]['ngay_xem'],\n          xem_chua: array[i]['xem_chua'],\n          ten: array[i]['ten']\n        });\n      }\n\n      ; // lưu vào danh sách file đã gửi, không lưu file ghi âm\n\n      if (loai != 'gui_ghi_am') {\n        this.db.database.ref('file_da_gui_ws').child(ma_cuoc_tro_chuyen).child(ref.key).set({\n          ma_tai_khoan: ma_tai_khoan,\n          ten_file: tenFile,\n          url: tin_nhan,\n          loai_tin_nhan: loai,\n          ngay_gui: currentTime,\n          ton_tai: 0\n        });\n      } // gửi tin nhắn websocket\n\n\n      this.submitMessageWebsocket(ma_cuoc_tro_chuyen, ref.key);\n    });\n  } // truy cập vào ảnh trong firestorage\n\n\n  accessluu_fileFireStorage(idCoversation, idImage) {\n    return this.storage.storage.ref('/luu_file_ws/' + idCoversation + '/' + idImage + '/');\n  }\n\n  openSelectEmoji(tin_nhan) {\n    if (tin_nhan.is_show_select_emoji) {\n      tin_nhan.is_show_select_emoji = false;\n    } else {\n      for (let i = 0; i < this.object_chat.cuoc_tro_truyen.tin_nhan.length; i++) {\n        this.object_chat.cuoc_tro_truyen.tin_nhan[i].is_show_select_emoji = false;\n      }\n\n      tin_nhan.is_show_select_emoji = true;\n    }\n  }\n\n  selectEmoji(cx, item, mtctc) {\n    item.is_show_select_emoji = false; // get data\n\n    let url = cx.img;\n    let loai = cx.ten;\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\n    let ten = this.my_name_service.myName; // is exits\n\n    let isExits = false;\n\n    if (item.is_exits_dscx) {\n      for (let i = 0; i < item.cam_xuc_tin_nhan.length; i++) {\n        if (item.cam_xuc_tin_nhan[i].ma_tai_khoan == ma_tai_khoan && item.cam_xuc_tin_nhan[i].loai_cam_xuc == loai) {\n          isExits = true;\n          break;\n        }\n      }\n    } else {\n      isExits = false;\n    }\n\n    if (!isExits) {\n      // add to firebase\n      this.db.object(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + mtctc + \"/\" + item.ma_tin_nhan + \"/cam_xuc_tin_nhan/\" + ma_tai_khoan).update({\n        ten: ten,\n        url: url,\n        loai: loai\n      });\n    } else {\n      //remove\n      this.db.object(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + mtctc + \"/\" + item.ma_tin_nhan + \"/cam_xuc_tin_nhan/\" + ma_tai_khoan).remove();\n    }\n  } // gửi tin nhắn websocket\n\n\n  submitMessageWebsocket(ma_cuoc_tro_chuyen, ma_tin_nhan) {\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\")); // gửi tin nhắn 1 : 1\n\n    if (this.object_chat.cuoc_tro_truyen.loai_cuoc_tro_truyen == 'don') {\n      this.db.database.ref('thanh_vien_cuoc_tro_chuyen_ws').child(ma_cuoc_tro_chuyen).once('value', members => {\n        members.forEach(eleMember => {\n          if (eleMember.key != ma_tai_khoan) {\n            this.db.database.ref('tai_khoan_ws').child(eleMember.key).once('value', infor => {\n              this.chat_page_content_websocket.sendMessagesPeople(infor.val().email, ma_tin_nhan);\n            });\n          }\n        });\n      }); // gửi tin nhắn nhóm\n    } else {\n      this.db.database.ref('thong_tin_tro_chuyen_nhom_ws').child(ma_cuoc_tro_chuyen).once('value', group => {\n        this.chat_page_content_websocket.sendMessagesGroup(group.val().ten_nhom, ma_tin_nhan);\n      });\n    }\n  }\n\n}\n\nChatPageChatPageContentWsService.ɵfac = function ChatPageChatPageContentWsService_Factory(t) {\n  return new (t || ChatPageChatPageContentWsService)(i0.ɵɵinject(i1.AngularFireDatabase), i0.ɵɵinject(i2.DomSanitizer), i0.ɵɵinject(i3.AngularFireStorage), i0.ɵɵinject(i4.MyNameWsService), i0.ɵɵinject(i5.ChatPageContentWebsocketService));\n};\n\nChatPageChatPageContentWsService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: ChatPageChatPageContentWsService,\n  factory: ChatPageChatPageContentWsService.ɵfac,\n  providedIn: 'root'\n});","map":{"version":3,"sources":["C:\\Users\\Administrator\\Desktop\\FrontEnd_ThayLong_Nhom-21\\app-chat\\src\\app\\service\\ws\\chat-page\\chat-page-chat-page\\chat-page-chat-page-content\\chat-page-chat-page-content-ws.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable } from '@angular/core';\r\nimport { AngularFireDatabase } from '@angular/fire/database';\r\nimport { AngularFireStorage } from '@angular/fire/storage';\r\nimport { DomSanitizer } from '@angular/platform-browser';\r\n\r\nimport {  Subscription } from 'rxjs';\r\nimport { finalize } from 'rxjs/operators';\r\nimport { ObjectChatContentWS } from 'src/app/models/ws/chat-page/chat-page-chat-page/content/object_chat_content_ws';\r\nimport { ObjectDangNhapWS } from 'src/app/models/ws/chat-page/chat-page-chat-page/content/object_dang_nhap_ws';\r\nimport { CamXucTinNhanWS } from 'src/app/models/ws/chat-page/chat-page-chat-page/content/select-emoji/cam_xuc_tin_nhan_ws';\r\nimport { EmojiMessengerWS } from 'src/app/models/ws/chat-page/chat-page-chat-page/content/select-emoji/emoji_messenger_ws';\r\nimport { ChatPageCuocTroChuyenWS } from 'src/app/models/ws/chat-page/chat-page-friends-page/chat_page_cuoc_tro_chuyen_ws';\r\nimport { ChatPageObjectTinNhanFriendWS } from 'src/app/models/ws/chat-page/chat-page-friends-page/chat_page_object_tin_nhan_friend_ws';\r\nimport { ChatPageTinhTrangXemWS } from 'src/app/models/ws/chat-page/chat-page-friends-page/chat_page_tinh_trang_xem_ws';\r\nimport { ChatPageTinNhanWS } from 'src/app/models/ws/chat-page/chat-page-friends-page/chat_page_tin_nhan_ws';\r\nimport { FileUploadWS } from 'src/app/models/ws/file-upload/file_upload_ws';\r\nimport { MyNameWsService } from '../../../my-name/my-name-ws.service';\r\nimport { ChatPageContentWebsocketService } from './chat-page-content-websocket.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ChatPageChatPageContentWsService {\r\n// Đối tượng đang chat \r\npublic object_chat: ObjectChatContentWS;\r\n// Danh sách mã tài khoản bạn bè\r\npublic ban_bes: string[];\r\n// oninput\r\npublic onInput: boolean;\r\n// Đối tượng tượng đang nhập\r\npublic dang_nhaps: ObjectDangNhapWS[];\r\n\r\n// tin nhắn lấy từ websocket\r\npublic messagesWebsocket: string[] = [];\r\n// kiểm tra load lần đầu websocket\r\npublic checkLoadMessageWS: boolean = false;\r\n// service\r\n// tin nhan\r\ntin_nhans: ChatPageTinNhanWS[] = [];\r\npublic layAllBanBe: Subscription;\r\npublic layLoaiCuocTroChuyen: Subscription;\r\npublic layThongTinNhom: Subscription;\r\npublic layThanhVien: Subscription;\r\npublic layThongTinTaiKhoan: Subscription;\r\npublic layTinNhan: Subscription;\r\npublic layNhungOngDangNhap: Subscription;\r\npublic layLanCuoiOnline: Subscription;\r\n\r\n  constructor\r\n    (\r\n      private db: AngularFireDatabase,\r\n      // pipi html\r\n      public sanitized: DomSanitizer,\r\n\r\n      private storage: AngularFireStorage,\r\n\r\n      public my_name_service: MyNameWsService,\r\n      \r\n      public chat_page_content_websocket: ChatPageContentWebsocketService\r\n      \r\n    ) {\r\n    this.object_chat = new ObjectChatContentWS();\r\n    this.object_chat.cuoc_tro_truyen = new ChatPageCuocTroChuyenWS();\r\n    this.dang_nhaps = [];\r\n    // Hàm update lại ban_bes 5s 1 lần\r\n    this.update();\r\n    // Hàm cập nhật đang nhập 3s 1 lần\r\n    this.updateDangNhap();\r\n  }\r\n\r\n  public updateOnInput(id: string) {\r\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n    let hinh = \"\";\r\n    let ten = \"\";\r\n    if (this.object_chat.thanh_vien != null) {\r\n      for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\r\n        if (this.object_chat.thanh_vien[i].ma_tai_khoan == ma_tai_khoan) {\r\n          hinh = this.object_chat.thanh_vien[i].link_hinh_dai_dien;\r\n          ten = this.object_chat.thanh_vien[i].ten_da_duoc_xu_ly;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    setTimeout(() => {\r\n      let current = Number(new Date());\r\n      this.db.object(\"/trang_thai_dang_nhap_ws/\" + id + \"/\" + ma_tai_khoan).update({ lan_cuoi_dang_nhap: current, hinh: hinh, ten: ten })\r\n      if (this.onInput) {\r\n        this.updateOnInput(id);\r\n      }\r\n    }, 2500);\r\n  }\r\n\r\n  public getDangNhap(id: string) {\r\n    return this.db.object(\"/trang_thai_dang_nhap_ws/\" + id).snapshotChanges();\r\n  }\r\n\r\n  public dienThongTinDangNhap(object: Object) {\r\n    if (object != null) {\r\n      let array: ObjectDangNhapWS[] = [];\r\n      let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n      Object.entries(object).forEach(([ma_thanh_vien, data_thanh_vien]) => {\r\n        if (ma_thanh_vien != ma_tai_khoan) {\r\n          let o = new ObjectDangNhapWS();\r\n          o.ma_tai_khoan = ma_thanh_vien;\r\n          o.lan_cuoi_dang_nhap = data_thanh_vien['lan_cuoi_dang_nhap'];\r\n          o.hinh = data_thanh_vien['hinh'];\r\n          o.ten = data_thanh_vien['ten'];\r\n          array.push(o);\r\n        }\r\n      });\r\n      // Xem thử ông nào quá 2s thì xóa\r\n      // ông nào rời nhóm rồi cũng xóa\r\n      let currentTime = Number(new Date());\r\n      let count = 0;\r\n      while (count < array.length) {\r\n        if (currentTime - array[count].lan_cuoi_dang_nhap > 2000 || this.object_chat.checkRoiChua(array[count].ma_tai_khoan)) {\r\n          array.splice(count, 1);\r\n        } else {\r\n          array[count].getNoiDung();\r\n          count++;\r\n        }\r\n      }\r\n      this.dang_nhaps = array;\r\n    }\r\n  }\r\n\r\n  public updateDangNhap() {\r\n    setTimeout(() => {\r\n      // Xem thử ông nào quá 2s thì xóa\r\n      let currentTime = Number(new Date());\r\n      let count = 0;\r\n      while (count < this.dang_nhaps.length) {\r\n        if (currentTime - this.dang_nhaps[count].lan_cuoi_dang_nhap > 2000) {\r\n          this.dang_nhaps.splice(count, 1);\r\n        } else {\r\n          count++;\r\n        }\r\n      }\r\n      this.updateDangNhap();\r\n    }, 3000);\r\n  }\r\n\r\n  public update(): void {\r\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n    setTimeout(() => {\r\n      // Kiểm tra online\r\n      let currentTime = Number(new Date());\r\n      if (this.object_chat != null) {\r\n        let isOnline = false;\r\n        if (this.object_chat.thanh_vien != null) {\r\n          for (let j = 0; j < this.object_chat.thanh_vien.length; j++) {\r\n            if (this.object_chat.thanh_vien[j].ma_tai_khoan != ma_tai_khoan) {\r\n              this.db.database.ref('cai_dat_ws').child(this.object_chat.thanh_vien[j].ma_tai_khoan).on('value', set => {\r\n                if(set.val().trang_thai_hoat_dong == 'tat')\r\n                  isOnline = false;\r\n                else {\r\n                  if (this.object_chat.cuoc_tro_truyen.loai_cuoc_tro_truyen == 'nhom') {\r\n                    if (this.object_chat.thanh_vien[j].roi_chua == 'chua') {\r\n                      let last_time = this.object_chat.thanh_vien[j].lan_cuoi_dang_nhap;\r\n                      let overTime = currentTime - last_time;\r\n                      if (overTime < 10000) {\r\n                        isOnline = true;\r\n                      }\r\n                    }\r\n                  } else {\r\n                    let last_time = this.object_chat.thanh_vien[j].lan_cuoi_dang_nhap;\r\n                    let overTime = currentTime - last_time;\r\n                    if (overTime < 10000) {\r\n                      isOnline = true;\r\n                    }\r\n                  }\r\n                }\r\n              })\r\n              if(isOnline)\r\n                break;\r\n            }\r\n          }\r\n        }\r\n        this.object_chat.is_online = isOnline;\r\n      }\r\n      this.update();\r\n    }, 5000);\r\n  }\r\n\r\n  public sumitTinNhan(ma_cuoc_tro_chuyen: string, tin_nhan: string, loai: string, ten: string) {\r\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n    let currentTime = Number(new Date());\r\n    // Tin nhắn\r\n    this.db.list(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen).push(\r\n      {\r\n        dia_chi_file: \"\",\r\n        link_file: \"\",\r\n        loai_tin_nhan: loai,\r\n        [\"ma_tai_khoan\"]: ma_tai_khoan,\r\n        ten: ten,\r\n        ma_tin_nhan_phan_hoi: \"\",\r\n        ngay_gui: currentTime,\r\n        noi_dung: tin_nhan,\r\n      }\r\n    ).then((ref) => {\r\n      // Lấy all thành viên\r\n      let array: Object[] = [];\r\n      array.push({ ma_tai_khoan: ma_tai_khoan, ngay_nhan: 0, ngay_xem: currentTime, xem_chua: \"roi\", ten: ten });\r\n      for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\r\n        array.push({ ma_tai_khoan: this.object_chat.thanh_vien[i].ma_tai_khoan, ngay_nhan: 0, ngay_xem: 0, xem_chua: \"chua\", ten: this.object_chat.thanh_vien[i].ten });\r\n      }\r\n      for (let i = 0; i < array.length; i++) {\r\n        this.db.object(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen + \"/\" + ref.key + \"/tinh_trang_xem/\" + array[i]['ma_tai_khoan']).update(\r\n          {\r\n            ngay_nhan: array[i]['ngay_nhan'],\r\n            ngay_xem: array[i]['ngay_xem'],\r\n            xem_chua: array[i]['xem_chua'],\r\n            ten: array[i]['ten'],\r\n          }\r\n        )\r\n      };\r\n      // gửi tin nhắn websocket\r\n      this.submitMessageWebsocket(ma_cuoc_tro_chuyen, ref.key)\r\n    });\r\n   ;\r\n  }\r\n\r\n  public sumitTinNhanThongBaoTaoNhom(ma_cuoc_tro_chuyen: string, tin_nhan: string, loai: string, ten: string) {\r\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n    let currentTime = Number(new Date());\r\n    // Tin nhắn\r\n    this.db.list(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen).push(\r\n      {\r\n        dia_chi_file: \"\",\r\n        link_file: \"\",\r\n        loai_tin_nhan: loai,\r\n        [\"ma_tai_khoan\"]: ma_tai_khoan,\r\n        ten: ten,\r\n        ma_tin_nhan_phan_hoi: \"\",\r\n        ngay_gui: currentTime,\r\n        noi_dung: tin_nhan,\r\n      }\r\n    ).then((ref) => {\r\n      // Lấy all thành viên\r\n      let array: Object[] = [];\r\n      array.push({ ma_tai_khoan: ma_tai_khoan, ngay_nhan: 0, ngay_xem: currentTime, xem_chua: \"roi\", ten: ten });\r\n      for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\r\n        array.push({ ma_tai_khoan: this.object_chat.thanh_vien[i].ma_tai_khoan, ngay_nhan: 0, ngay_xem: 0, xem_chua: \"chua\", ten: this.object_chat.thanh_vien[i].ten });\r\n      }\r\n      for (let i = 0; i < array.length; i++) {\r\n        this.db.object(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen + \"/\" + ref.key + \"/tinh_trang_xem/\" + array[i]['ma_tai_khoan']).update(\r\n          {\r\n            ngay_nhan: array[i]['ngay_nhan'],\r\n            ngay_xem: array[i]['ngay_xem'],\r\n            xem_chua: array[i]['xem_chua'],\r\n            ten: array[i]['ten'],\r\n          }\r\n        )\r\n      };\r\n        // gửi tin nhắn websocket\r\n      this.submitMessageWebsocket(ma_cuoc_tro_chuyen, ref.key)\r\n    });\r\n  }\r\n\r\n  public sumitTinNhanBTCX(ma_cuoc_tro_chuyen: string, tin_nhan: string, loai: string, ten: string, alt: string) {\r\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n    let currentTime = Number(new Date());\r\n    // Tin nhắn\r\n    this.db.list(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen).push(\r\n      {\r\n        dia_chi_file: \"\",\r\n        link_file: \"\",\r\n        loai_tin_nhan: loai,\r\n        [\"ma_tai_khoan\"]: ma_tai_khoan,\r\n        ten: ten,\r\n        ma_tin_nhan_phan_hoi: \"\",\r\n        ngay_gui: currentTime,\r\n        noi_dung: tin_nhan,\r\n        alt: alt,\r\n      }\r\n    ).then((ref) => {\r\n      // Lấy all thành viên\r\n      let array: Object[] = [];\r\n      array.push({ ma_tai_khoan: ma_tai_khoan, ngay_nhan: 0, ngay_xem: currentTime, xem_chua: \"roi\", ten: ten });\r\n      for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\r\n        array.push({ ma_tai_khoan: this.object_chat.thanh_vien[i].ma_tai_khoan, ngay_nhan: 0, ngay_xem: 0, xem_chua: \"chua\", ten: this.object_chat.thanh_vien[i].ten });\r\n      }\r\n      for (let i = 0; i < array.length; i++) {\r\n        this.db.object(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen + \"/\" + ref.key + \"/tinh_trang_xem/\" + array[i]['ma_tai_khoan']).update(\r\n          {\r\n            ngay_nhan: array[i]['ngay_nhan'],\r\n            ngay_xem: array[i]['ngay_xem'],\r\n            xem_chua: array[i]['xem_chua'],\r\n            ten: array[i]['ten'],\r\n          }\r\n        )\r\n      };\r\n        // gửi tin nhắn websocket\r\n      this.submitMessageWebsocket(ma_cuoc_tro_chuyen, ref.key)\r\n    });\r\n  }\r\n\r\n\r\n  public getBanBe() {\r\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n    return this.db.object(\"/ban_be_ws/\" + ma_tai_khoan).snapshotChanges();\r\n  }\r\n\r\n  public layBanBe(object: Object) {\r\n    let ban_bes: string[] = [];\r\n    if (object != null) {\r\n      Object.entries(object).forEach(([ma_thanh_vien, data_thanh_vien]) => {\r\n        if (data_thanh_vien['ton_tai'] == 0) {\r\n          ban_bes.push(ma_thanh_vien);\r\n        }\r\n      });\r\n    }\r\n    this.ban_bes = ban_bes;\r\n  }\r\n\r\n  public dienThongTinCoBan(object: Object): void {\r\n    if (object != null) {\r\n      this.object_chat.cuoc_tro_truyen.loai_cuoc_tro_truyen = object['loai_cuoc_tro_truyen'];\r\n      this.object_chat.cuoc_tro_truyen.mau = object['mau'];\r\n      this.object_chat.cuoc_tro_truyen.mau_tren = object['mau_tren'];\r\n      this.object_chat.cuoc_tro_truyen.mau_duoi = object['duoi'];\r\n      this.object_chat.cuoc_tro_truyen.bieu_tuong_cam_xuc = object['bieu_tuong_cam_xuc'];\r\n      if (this.object_chat.cuoc_tro_truyen.mau == '#3275f7') {\r\n        this.object_chat.cuoc_tro_truyen.mau = 'linear-gradient(0deg,#3275f7, #3275f7)';\r\n        this.object_chat.cuoc_tro_truyen.mau_tren = \"#3275f7\";\r\n        this.object_chat.cuoc_tro_truyen.mau_duoi = \"#3275f7\";\r\n      }\r\n    }\r\n  }\r\n\r\n  public getObjectChat(ma_cuoc_tro_chuyen: string) {\r\n    return this.db.object(\"/cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen).snapshotChanges();\r\n  }\r\n\r\n  public getObjectChatThanhVien(ma_cuoc_tro_chuyen: string) {\r\n    return this.db.object(\"/thanh_vien_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen).snapshotChanges();\r\n  }\r\n\r\n  public getThongTinTroChuyenNhom(ma_cuoc_tro_chuyen: string) {\r\n    return this.db.object(\"/thong_tin_tro_chuyen_nhom_ws/\" + ma_cuoc_tro_chuyen).snapshotChanges();\r\n  }\r\n\r\n  public dienThongTinNhom(object: Object) {\r\n    if (object != null) {\r\n      if (object['ton_tai'] == 0) {\r\n        this.object_chat.cuoc_tro_truyen.ten_nhom = object['ten-nhom'];\r\n        this.object_chat.cuoc_tro_truyen.ma_tai_khoan_chu_so_huu = object['chu_so_huu'];\r\n        this.object_chat.cuoc_tro_truyen.ngay_tao = object['ngay_tao'];\r\n        this.object_chat.cuoc_tro_truyen.ton_tai = object['ton_tai'];\r\n      \r\n      }\r\n    } else {\r\n      this.object_chat.cuoc_tro_truyen.ten_nhom = null;\r\n      this.object_chat.cuoc_tro_truyen.ma_tai_khoan_chu_so_huu = null;\r\n      this.object_chat.cuoc_tro_truyen.ngay_tao = null;\r\n      this.object_chat.cuoc_tro_truyen.ton_tai = null;\r\n    }\r\n  }\r\n\r\n  public dienThanhVien(object: Object) {\r\n    let array: ChatPageObjectTinNhanFriendWS[] = [];\r\n    if (object != null) {\r\n      Object.entries(object).forEach(([ma_thanh_vien, data_thanh_vien]) => {\r\n        let objectChatThanhVien = new ChatPageObjectTinNhanFriendWS();\r\n        objectChatThanhVien.ma_tai_khoan = ma_thanh_vien;\r\n        objectChatThanhVien.ngay_tham_gia = data_thanh_vien['ngay_tham_gia'];\r\n        objectChatThanhVien.trang_thai = data_thanh_vien['trang_thai'];\r\n        objectChatThanhVien.roi_chua = data_thanh_vien['roi_chua'];\r\n        objectChatThanhVien.ngay_roi_di = data_thanh_vien['ngay_roi_di'];\r\n        array.push(objectChatThanhVien);\r\n      });\r\n    }\r\n    this.object_chat.thanh_vien = array;\r\n    // Có được thành viên kiểm tra rời chưa\r\n    this.object_chat.getIsRoiChua();\r\n  }\r\n\r\n  public getDataThanhVien() {\r\n    return this.db.object(\"/tai_khoan_ws\").snapshotChanges();\r\n  }\r\n\r\n  public dienThongTinThanhVien(object: Object) {\r\n    Object.entries(object).forEach(([ma_thanh_vien, data_thanh_vien]) => {\r\n      for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\r\n        if (this.object_chat.thanh_vien[i].ma_tai_khoan == ma_thanh_vien) {\r\n          this.object_chat.thanh_vien[i].link_hinh_dai_dien = data_thanh_vien['link_hinh'];\r\n          this.object_chat.thanh_vien[i].ten = data_thanh_vien['ten'];\r\n          // Có tên rồi thì getName cho chính bản thân nó\r\n          this.object_chat.thanh_vien[i].getName();\r\n          // Có tên rồi thì lấy status connect để đổ ra cho đỡ lag\r\n          this.object_chat.getCreateFriends(this.ban_bes);\r\n        }\r\n      }\r\n    });\r\n    // Điền thông tin thành viên xong thì get img để đổ ra cho bớt lag\r\n    this.object_chat.getImgAvatars();\r\n  }\r\n\r\n  public dienLanCUoiOnline(object: Object) {\r\n    let count = 0;\r\n    Object.entries(object).forEach(([ma_thanh_vien, data_thanh_vien]) => {\r\n      for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\r\n        if (this.object_chat.thanh_vien[i].ma_tai_khoan == ma_thanh_vien) {\r\n          this.object_chat.thanh_vien[i].lan_cuoi_dang_nhap = data_thanh_vien['lan_cuoi_dang_nhap'];\r\n          count++;\r\n          break;\r\n        }\r\n      }\r\n    });\r\n    if (count != this.object_chat.thanh_vien.length) {\r\n      for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\r\n        if (this.object_chat.thanh_vien[i].lan_cuoi_dang_nhap == null) {\r\n          this.object_chat.thanh_vien[i].lan_cuoi_dang_nhap = 0;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public getLanCuoiOnline() {\r\n    return this.db.object(\"/lan_cuoi_dang_nhap_ws\").snapshotChanges();\r\n  }\r\n\r\n  public getTinNhan(id: string) {\r\n    return this.db.object(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + id).snapshotChanges();\r\n  }\r\n\r\n  // get tin nhắn từ websocket\r\n  dienTinNhanWebSocket(valueFire: object, ma_cuoc_tro_chuyen: string, page: number) {\r\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n    // gửi tin nhắn 1 : 1\r\n        if(this.object_chat.cuoc_tro_truyen.loai_cuoc_tro_truyen == 'don') {\r\n          this.db.database.ref('thanh_vien_cuoc_tro_chuyen_ws').child(ma_cuoc_tro_chuyen).once('value', members => {\r\n            members.forEach(eleMember=> {\r\n                if(eleMember.key != ma_tai_khoan) {\r\n                  this.db.database.ref('tai_khoan_ws').child(eleMember.key).once('value' , infor => {\r\n                      this.chat_page_content_websocket.getMessagesPeople(infor.val().email, page)\r\n                  })\r\n                }\r\n            });\r\n          })\r\n          // gửi tin nhắn nhóm\r\n        } else {\r\n          this.db.database.ref('thong_tin_tro_chuyen_nhom_ws').child(ma_cuoc_tro_chuyen).once('value' , group => {\r\n              this.chat_page_content_websocket.getMessagesGroup(group.val().ten_nhom, page)\r\n          })\r\n        }\r\n      // dùng asysc/await để bất động bộ chờ dữ liệu từ serve gửi về :3\r\n      this.chat_page_content_websocket.messages_list.subscribe(async data => {\r\n        let value = await JSON.parse(JSON.stringify(data));\r\n        if(this.object_chat.cuoc_tro_truyen.loai_cuoc_tro_truyen == 'don') {\r\n            // nếu là get tất cả tin nhắn\r\n            if(value.status == \"success\") {\r\n              if(await value.data.id === undefined ) {\r\n                console.log( await value.data.length)\r\n                await value.data.forEach( message => {\r\n                  if(!this.messagesWebsocket.includes(message.mes))\r\n                      this.messagesWebsocket.push(message.mes);\r\n                });\r\n                // nếu là nhận tin nhắn từ người khác\r\n              } else {\r\n                if(await !this.messagesWebsocket.includes(value.data.mes))\r\n                    this.messagesWebsocket.push(value.data.mes)\r\n              }\r\n              await this.dienTinNhan(valueFire, ma_cuoc_tro_chuyen);\r\n\r\n              // đệ quy để lấy ra tất cả tin nhắn\r\n              if(await value.data.length >= 50 && !this.checkLoadMessageWS) {\r\n                this.dienTinNhanWebSocket(valueFire,ma_cuoc_tro_chuyen, page + 1)\r\n              } else {\r\n                this.checkLoadMessageWS = true;\r\n              }\r\n            }\r\n        }\r\n      })\r\n    \r\n  }\r\n  public dienTinNhan(value: object, maCuocTroChuyen:string) {\r\n    // let tin_nhans: ChatPageTinNhanWS[] = [];\r\n    if (value != null) {\r\n      Object.entries(value).forEach(([ma_tin_nhan, data_tin_nhan]) => {\r\n        if(this.messagesWebsocket.includes(ma_tin_nhan)) {\r\n          let tin_nhan = new ChatPageTinNhanWS();\r\n          tin_nhan.ma_tin_nhan = ma_tin_nhan;\r\n          tin_nhan.dia_chi_file = data_tin_nhan['dia_chi_file'];\r\n          tin_nhan.link_file = data_tin_nhan['link_file'];\r\n          tin_nhan.loai_tin_nhan = data_tin_nhan['loai_tin_nhan'];\r\n          tin_nhan.ma_tai_khoan = data_tin_nhan['ma_tai_khoan'];\r\n          tin_nhan.ma_tin_nhan_phan_hoi = data_tin_nhan['ma_tin_nhan_phan_hoi'];\r\n          tin_nhan.ngay_gui = data_tin_nhan['ngay_gui'];\r\n          tin_nhan.ngay_thu_hoi = data_tin_nhan['ngay_thu_hoi'];\r\n          tin_nhan.noi_dung = data_tin_nhan['noi_dung'];\r\n          tin_nhan.ten = data_tin_nhan['ten'];\r\n          if(tin_nhan.loai_tin_nhan == 'gui_hinh') {\r\n            tin_nhan.danh_sach_url_anh = []\r\n            this.accessluu_fileFireStorage(maCuocTroChuyen,tin_nhan.noi_dung).listAll().then((result)=>{\r\n                result.items.forEach(element => {\r\n                  element.getDownloadURL().then((url)=> {\r\n                    tin_nhan.danh_sach_url_anh.push(url)\r\n                  })\r\n                });\r\n              })\r\n          }\r\n          // Tình trạng xem\r\n          let tinhTrangXem: object = data_tin_nhan['tinh_trang_xem'];\r\n          let tinh_trang_xems: ChatPageTinhTrangXemWS[] = [];\r\n          if (tinhTrangXem != null) {\r\n            Object.entries(tinhTrangXem).forEach(([ma_tai_khoan, data]) => {\r\n              let o = new ChatPageTinhTrangXemWS();\r\n              o.ma_tai_khoan = ma_tai_khoan;\r\n              o.ngay_xem = data['ngay_xem'];\r\n              o.xem_chua = data['xem_chua'];\r\n              o.ngay_nhan = data['ngay_nhan'];\r\n              o.ten = data['ten'];\r\n              o.is_roi_chua = this.taiKhoanTinhTrangXemRoiChua(o.ma_tai_khoan);\r\n              o.getNoiDung();\r\n              tinh_trang_xems.push(o);\r\n            });\r\n            tin_nhan.tinh_trang_xem = tinh_trang_xems;\r\n            // Oke h làm một số chuyện trc cho đỡ lag\r\n            // Nếu là loại thông báo thì get Noi dung thong bao\r\n            if (tin_nhan.loai_tin_nhan == 'thong_bao') {\r\n              tin_nhan.getNoiDungThongBao();\r\n            }\r\n            // Kiểm tra có phải là bản thân ko\r\n            tin_nhan.getIsBanThan();\r\n            // Lấy thời gian của tin nhắn\r\n            tin_nhan.getTime();\r\n            // Lấy tình trạng đã gửi\r\n            tin_nhan.getIsDaGui();\r\n            // Lấy tình trạng đã chuyển\r\n            tin_nhan.getIsDaChuyen();\r\n            // Lấy tình trạng có người xem\r\n            tin_nhan.getIsCoNguoiXem();\r\n            // Lấy tên đã được sử lý\r\n            tin_nhan.getTen();\r\n            // Lấy nội dung html\r\n            tin_nhan.getNoiDungHTMLTinNhan(this.sanitized);\r\n            // Emoji\r\n            let cam_xuc_tin_nhan: object = data_tin_nhan['cam_xuc_tin_nhan'];\r\n            let camXucs: CamXucTinNhanWS[] = [];\r\n            if (cam_xuc_tin_nhan != null) {\r\n              Object.entries(cam_xuc_tin_nhan).forEach(([k, v]) => {\r\n                let cx = new CamXucTinNhanWS();\r\n                cx.ma_tai_khoan = k;\r\n                cx.ten = v['ten'];\r\n                cx.loai_cam_xuc = v['loai'];\r\n                cx.url = v['url'];\r\n                camXucs.push(cx);\r\n              });\r\n              tin_nhan.cam_xuc_tin_nhan = camXucs;\r\n              // is exits dscx\r\n              tin_nhan.getIsExitsDSCX();\r\n              // tooltip p\r\n              tin_nhan.getToolTipP();\r\n              // exits all\r\n              tin_nhan.getIsExitsCX();\r\n            }\r\n            let checkAdd = false\r\n            this.tin_nhans.forEach(element => {\r\n                if(element.ma_tin_nhan == tin_nhan.ma_tin_nhan)\r\n                  checkAdd = true;\r\n            });\r\n            !checkAdd ? this.tin_nhans.push(tin_nhan) : ''\r\n            \r\n          }\r\n        }\r\n      });\r\n    }\r\n    // Xem ông nào đang bật biểu tưởng cảm xúc thì bật ổng dậy\r\n    // Rồi gán lại tin nhắn mới\r\n    this.handleOpenSelectEmojiAndUpdate(this.tin_nhans);\r\n    // Lọc lại tin nhắn lấy những tin nhắn trước thời gian ta đã rời đi\r\n    if (this.object_chat.is_roi_chua) {\r\n      this.fillter();\r\n    }\r\n    // Có được list tin nhắn hoàn thiện ta tính số người đã xem được ở từng tin nhắn\r\n    for (let i = 0; i < this.object_chat.cuoc_tro_truyen.tin_nhan.length; i++) {\r\n      this.object_chat.cuoc_tro_truyen.tin_nhan[i].getSoNguoiXemDangOViTriTinNhanNay(i, this.object_chat.cuoc_tro_truyen.tin_nhan);\r\n    }\r\n    // Sau đó tạo các tin nhắn thời gian kèm cặp vào cách nhau 15p\r\n    this.addTimeSpace();\r\n    // Tính margin và border\r\n    this.handleBorderAndMargin();\r\n  }\r\n\r\n  public handleOpenSelectEmojiAndUpdate(tin_nhans: ChatPageTinNhanWS[]) {\r\n    let mtks: string = null;\r\n    if (this.object_chat.cuoc_tro_truyen.tin_nhan != null && this.object_chat.cuoc_tro_truyen.tin_nhan.length > 0) {\r\n      for (let i = 0; i < this.object_chat.cuoc_tro_truyen.tin_nhan.length; i++) {\r\n        if (this.object_chat.cuoc_tro_truyen.tin_nhan[i].is_show_select_emoji) {\r\n          mtks = this.object_chat.cuoc_tro_truyen.tin_nhan[i].ma_tin_nhan;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    if (mtks != null) {\r\n      for (let i = 0; i < tin_nhans.length; i++) {\r\n        if (tin_nhans[i].ma_tin_nhan == mtks) {\r\n          tin_nhans[i].is_show_select_emoji = true;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    this.object_chat.cuoc_tro_truyen.tin_nhan = tin_nhans;\r\n  }\r\n\r\n  public taiKhoanTinhTrangXemRoiChua(mtk: string): boolean {\r\n    for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\r\n      if (this.object_chat.thanh_vien[i].ma_tai_khoan == mtk) {\r\n        if (this.object_chat.thanh_vien[i].roi_chua == 'roi') {\r\n          return true;\r\n        }\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  public fillter() {\r\n    let i = this.object_chat.cuoc_tro_truyen.tin_nhan.length - 1;\r\n    let timeRoiDi = this.object_chat.time_roi_di;\r\n    while (i > -1) {\r\n      if (this.object_chat.cuoc_tro_truyen.tin_nhan[i].ngay_gui > timeRoiDi) {\r\n        this.object_chat.cuoc_tro_truyen.tin_nhan.splice(i, 1);\r\n        i--;\r\n      } else {\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  public handleBorderAndMargin() {\r\n    let count = 0;\r\n    for (let i = 0; i < this.object_chat.cuoc_tro_truyen.tin_nhan.length; i++) {\r\n      // Tính xem nó có border top va bottom ko\r\n      // Thằng đầu tiên có border top\r\n      if (count == 0) {\r\n        this.object_chat.cuoc_tro_truyen.tin_nhan[i].isHaveBorderTop = true;\r\n      } else {\r\n        this.object_chat.cuoc_tro_truyen.tin_nhan[i].getIsHaveBorderTop(this.object_chat.cuoc_tro_truyen.tin_nhan[count - 1]);\r\n      }\r\n      // Kiểm tra borderbottom\r\n      if (count > 0) {\r\n        this.object_chat.cuoc_tro_truyen.tin_nhan[count - 1].getIsHaveBorderBottom(this.object_chat.cuoc_tro_truyen.tin_nhan[i]);\r\n      }\r\n      // Tính margin top cho tin nhắn\r\n      // Thằng đàu tiên luôn margin top 0px\r\n      if (count == 0) {\r\n        this.object_chat.cuoc_tro_truyen.tin_nhan[i].marginTop = \"0px\";\r\n      } else {\r\n        this.object_chat.cuoc_tro_truyen.tin_nhan[i].getMarginTopTinNhan(this.object_chat.cuoc_tro_truyen.tin_nhan[count - 1]);\r\n      }\r\n      count++;\r\n    }\r\n    // Thằng cuối cùng sẽ có border bottom\r\n    if (count > 0) {\r\n      this.object_chat.cuoc_tro_truyen.tin_nhan[count - 1].isHaveBorderBottom = true;\r\n    }\r\n  }\r\n\r\n  public addTimeSpace() {\r\n    let i = 0;\r\n    // Thời gian hiện tại\r\n    let nowTime = 0;\r\n    while (i < this.object_chat.cuoc_tro_truyen.tin_nhan.length) {\r\n      let time = this.object_chat.cuoc_tro_truyen.tin_nhan[i].ngay_gui;\r\n      // > 15 minutes?\r\n      if (time - nowTime > 15 * 60000) {\r\n        let object = new ChatPageTinNhanWS();\r\n        object.noi_dung = this.getTimeSpaceString(time);\r\n        object.loai_tin_nhan = 'thoi_gian';\r\n        nowTime = time;\r\n        this.object_chat.cuoc_tro_truyen.tin_nhan.splice(i, 0, object);\r\n        i += 2;\r\n      } else {\r\n        i++;\r\n      }\r\n    }\r\n  }\r\n\r\n  public getTimeSpaceString(time: number) {\r\n    let date = new Date(time);\r\n    let year = date.getFullYear();\r\n    let thang = date.getMonth() + 1;\r\n    let ngay = date.getDate();\r\n    let gio = date.getHours();\r\n    let phut = date.getMinutes();\r\n    return `${gio.toString().length > 1 ? gio : \"0\" + gio}:${phut.toString().length > 1 ? phut : \"0\" + phut}, ${ngay.toString().length > 1 ? ngay : \"0\" + ngay} Tháng ${thang.toString().length > 1 ? thang : \"0\" + thang}, ${year}`;\r\n  }\r\n\r\n\r\n  // lưu image vào lưu_file trong storage firebase\r\n  public saveImageluu_fileInStorage(image: FileUploadWS, idConversation: string, keyImage:string) {\r\n    let filePath: string = '/luu_file_ws/' + idConversation + \"/\" + keyImage + '/';\r\n    let newKey = Number(new Date());\r\n    let ref = this.storage.ref(filePath+newKey+image.file.name).put(image.file);\r\n    return ref;\r\n  }\r\n\r\n  // save file vao storage firebase\r\n  public saveFileluu_fileStorage(file: FileUploadWS, idConversation: string, newKey:string, typeFile:string) {\r\n    let filePath: string = '/luu_file_ws/' + idConversation + \"/\";\r\n    let ref = this.storage.ref(filePath+newKey+file.file.name).put(file.file);\r\n    let check100Percent = false;\r\n    ref.percentageChanges().subscribe((percent) => {\r\n      if (percent == 100) {\r\n        ref.snapshotChanges().pipe(finalize(() => {\r\n          this.storage.ref(filePath+newKey+file.file.name).getDownloadURL().subscribe((downloadURL) => {\r\n            if(!check100Percent) {\r\n              this.submitMessageFile(idConversation, downloadURL, typeFile,this.my_name_service.myName,file.name)\r\n              check100Percent = true;\r\n            }\r\n          })\r\n        })).subscribe();\r\n      }\r\n    })\r\n  }\r\n  // lưu link image vao danh sach file trong db\r\n  public submitMessageFile(ma_cuoc_tro_chuyen: string, tin_nhan: string, loai: string, ten: string, tenFile:string) {\r\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n    let currentTime = Number(new Date());\r\n    // Tin nhắn\r\n    this.db.list(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen).push(\r\n      {\r\n        dia_chi_file: \"\",\r\n        // xet link file la ten file\r\n        link_file: tenFile,\r\n        loai_tin_nhan: loai,\r\n        [\"ma_tai_khoan\"]: ma_tai_khoan,\r\n        ten: ten,\r\n        ma_tin_nhan_phan_hoi: \"\",\r\n        ngay_gui: currentTime,\r\n        noi_dung: tin_nhan,\r\n      }\r\n    ).then((ref) => {\r\n      // Lấy all thành viên\r\n      let array: Object[] = [];\r\n      array.push({ ma_tai_khoan: ma_tai_khoan, ngay_nhan: 0, ngay_xem: currentTime, xem_chua: \"roi\", ten: ten });\r\n      for (let i = 0; i < this.object_chat.thanh_vien.length; i++) {\r\n        array.push({ ma_tai_khoan: this.object_chat.thanh_vien[i].ma_tai_khoan, ngay_nhan: 0, ngay_xem: 0, xem_chua: \"chua\", ten: this.object_chat.thanh_vien[i].ten });\r\n      }\r\n      for (let i = 0; i < array.length; i++) {\r\n        this.db.object(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + ma_cuoc_tro_chuyen + \"/\" + ref.key + \"/tinh_trang_xem/\" + array[i]['ma_tai_khoan']).update(\r\n          {\r\n            ngay_nhan: array[i]['ngay_nhan'],\r\n            ngay_xem: array[i]['ngay_xem'],\r\n            xem_chua: array[i]['xem_chua'],\r\n            ten: array[i]['ten'],\r\n          }\r\n        )\r\n      };\r\n      // lưu vào danh sách file đã gửi, không lưu file ghi âm\r\n      if(loai != 'gui_ghi_am') {\r\n        this.db.database.ref('file_da_gui_ws').child(ma_cuoc_tro_chuyen).child(ref.key).set({\r\n          ma_tai_khoan: ma_tai_khoan,\r\n          ten_file: tenFile,\r\n          url: tin_nhan,\r\n          loai_tin_nhan: loai,\r\n          ngay_gui: currentTime,\r\n          ton_tai: 0\r\n        })\r\n      }\r\n        // gửi tin nhắn websocket\r\n      this.submitMessageWebsocket(ma_cuoc_tro_chuyen, ref.key)\r\n    });\r\n  }\r\n  // truy cập vào ảnh trong firestorage\r\n  public accessluu_fileFireStorage(idCoversation:string, idImage: string){\r\n    return this.storage.storage.ref('/luu_file_ws/' + idCoversation + '/' + idImage +'/');\r\n  }\r\n  public openSelectEmoji(tin_nhan: ChatPageTinNhanWS) {\r\n    if (tin_nhan.is_show_select_emoji) {\r\n      tin_nhan.is_show_select_emoji = false;\r\n    } else {\r\n      for (let i = 0; i < this.object_chat.cuoc_tro_truyen.tin_nhan.length; i++) {\r\n        this.object_chat.cuoc_tro_truyen.tin_nhan[i].is_show_select_emoji = false;\r\n      }\r\n      tin_nhan.is_show_select_emoji = true;\r\n    }\r\n  }\r\n\r\n  public selectEmoji(cx: EmojiMessengerWS, item: ChatPageTinNhanWS, mtctc: string) {\r\n    item.is_show_select_emoji = false;\r\n    // get data\r\n    let url = cx.img;\r\n    let loai = cx.ten;\r\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n    let ten = this.my_name_service.myName;\r\n    // is exits\r\n    let isExits = false;\r\n    if (item.is_exits_dscx) {\r\n      for (let i = 0; i < item.cam_xuc_tin_nhan.length; i++) {\r\n        if (item.cam_xuc_tin_nhan[i].ma_tai_khoan == ma_tai_khoan && item.cam_xuc_tin_nhan[i].loai_cam_xuc == loai) {\r\n          isExits = true;\r\n          break;\r\n        }\r\n      }\r\n    } else {\r\n      isExits = false;\r\n    }\r\n    if (!isExits) {\r\n      // add to firebase\r\n      this.db.object(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + mtctc + \"/\" + item.ma_tin_nhan + \"/cam_xuc_tin_nhan/\" + ma_tai_khoan).update({\r\n        ten: ten,\r\n        url: url,\r\n        loai: loai,\r\n      });\r\n    } else {\r\n      //remove\r\n      this.db.object(\"/chi_tiet_cuoc_tro_chuyen_ws/\" + mtctc + \"/\" + item.ma_tin_nhan + \"/cam_xuc_tin_nhan/\" + ma_tai_khoan).remove();\r\n    }\r\n  }\r\n\r\n  // gửi tin nhắn websocket\r\n  submitMessageWebsocket(ma_cuoc_tro_chuyen: string, ma_tin_nhan: string) {\r\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n    // gửi tin nhắn 1 : 1\r\n    if(this.object_chat.cuoc_tro_truyen.loai_cuoc_tro_truyen == 'don') {\r\n        this.db.database.ref('thanh_vien_cuoc_tro_chuyen_ws').child(ma_cuoc_tro_chuyen).once('value', members => {\r\n          members.forEach(eleMember=> {\r\n              if(eleMember.key != ma_tai_khoan) {\r\n                this.db.database.ref('tai_khoan_ws').child(eleMember.key).once('value' , infor => {\r\n                  this.chat_page_content_websocket.sendMessagesPeople(infor.val().email, ma_tin_nhan);\r\n                 \r\n                })\r\n              }\r\n          });\r\n        })\r\n        // gửi tin nhắn nhóm\r\n    } else {\r\n      this.db.database.ref('thong_tin_tro_chuyen_nhom_ws').child(ma_cuoc_tro_chuyen).once('value' , group => {\r\n        this.chat_page_content_websocket.sendMessagesGroup(group.val().ten_nhom, ma_tin_nhan)\r\n      })\r\n    }\r\n  }\r\n}\r\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}