{"ast":null,"code":"import _asyncToGenerator from \"E:/Important/FIT/project-front-end/FrontEnd_ThayLong_Nhom-21/app-chat/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport { UserVideo } from 'src/app/models/chat-page/call-video/user-video';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/fire/database\";\nimport * as i2 from \"src/app/service/my-name/my-name.service\";\nimport * as i3 from \"src/app/service/main-page/main-page.service\";\nimport * as i4 from \"./../chat-page-chat-page/chat-page-chat-page-content/chat-page-chat-page-content.service\";\nimport * as i5 from \"./../chat-page-chat-page/messenger-main.service\";\nexport let CallVideoService = /*@__PURE__*/(() => {\n  class CallVideoService {\n    constructor(db, my_name_service, main_page_service, content_service, messenger_main_service) {\n      this.db = db;\n      this.my_name_service = my_name_service;\n      this.main_page_service = main_page_service;\n      this.content_service = content_service;\n      this.messenger_main_service = messenger_main_service; // Request mediaDevices\n\n      this.mediaConstraints = {\n        audio: true,\n        video: true\n      }; // All user\n\n      this.all_user = []; // request 45s\n\n      this.countRequest = 0;\n\n      if (this.layAllUser == null) {\n        this.getData();\n      } else {\n        this.layAllUser.unsubscribe();\n        this.getData();\n      }\n    }\n\n    getData() {\n      this.layAllUser = this.db.object(\"/call_video\").snapshotChanges().subscribe(data => {\n        let array = [];\n        let isCall = false;\n        let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn\"));\n        Object.entries(data.payload.toJSON()).forEach(([k, v]) => {\n          let o = new UserVideo();\n          o.ma_tai_khoan = k;\n          o.bat_may_chua = v['bat_may_chua'];\n          o.goi_chua = v['goi_chua'];\n          o.thoi_gian_goi = v['thoi_gian_goi'];\n          o.thoi_gian_ket_thuc = v['thoi_gian_ket_thuc'];\n          o.tk_goi_minh = v['tk_goi_minh'];\n          o.hinh_tk_goi_minh = v['hinh_tk_goi_minh'];\n          o.ten_tk_goi_minh = v['ten_tk_goi_minh']; // Đang trong cuộc gọi\n\n          if (k == mtk && o.goi_chua == 'dang') {\n            isCall = true;\n          }\n\n          array.push(o);\n        });\n        this.all_user = array;\n\n        if (isCall) {\n          this.is_show = true;\n        } else {\n          this.is_show = false;\n        }\n      });\n    }\n\n    getVideoUserAndShow() {\n      var _this = this;\n\n      return _asyncToGenerator(function* () {\n        _this.localStream = yield navigator.mediaDevices.getUserMedia(_this.mediaConstraints);\n        _this.is_show = true;\n      })();\n    }\n\n    callVideo(tk) {\n      var _this2 = this;\n\n      return _asyncToGenerator(function* () {\n        _this2.now_user = tk; // Check thử available\n\n        if (_this2.isAvailable(tk.ma_tai_khoan)) {\n          // Lấy video\n          _this2.getVideoUserAndShow(); // Cập nhật lại trong firebase\n\n\n          _this2.writeToFirebase(tk); // Time out 45s\n\n\n          _this2.countRequest = 0;\n\n          _this2.request45second(); // Status là gọi\n\n\n          _this2.status = 1;\n        } else {\n          // Lấy video\n          _this2.localStream = null;\n          _this2.is_show = true;\n        }\n      })();\n    }\n\n    request45second() {\n      setTimeout(() => {\n        this.countRequest++;\n\n        if (this.countRequest <= 45) {\n          let isOk = false;\n\n          for (let i = 0; i < this.all_user.length; i++) {\n            if (this.all_user[i].ma_tai_khoan == this.now_user.ma_tai_khoan) {\n              if (this.all_user[i].bat_may_chua == 'roi') {\n                isOk = true;\n              }\n\n              break;\n            }\n          }\n\n          if (!isOk) {\n            this.request45second();\n          } else {\n            // Có người bắt máy\n            // Chuyển status sang bắt máy\n            this.status = 2;\n          }\n        } else {\n          this.cuocGoiNho();\n        }\n      }, 1000);\n    }\n\n    writeToFirebase(tk) {\n      let currentTime = Number(new Date());\n      let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn\"));\n      this.db.object(\"/call_video/\" + tk.ma_tai_khoan).update({\n        thoi_gian_goi: currentTime,\n        goi_chua: \"dang\",\n        bat_may_chua: \"chua\",\n        tk_goi_minh: mtk,\n        hinh_tk_goi_minh: this.main_page_service.img,\n        ten_tk_goi_minh: this.my_name_service.myName\n      });\n      this.db.object(\"/call_video/\" + mtk).update({\n        thoi_gian_goi: currentTime,\n        goi_chua: \"dang\",\n        bat_may_chua: \"roi\",\n        tk_goi_minh: 'khong_co',\n        hinh_tk_goi_minh: 'khong_co',\n        ten_tk_goi_minh: 'khong_co'\n      });\n    }\n\n    isAvailable(mtk) {\n      for (let i = 0; i < this.all_user.length; i++) {\n        if (this.all_user[i].ma_tai_khoan == mtk) {\n          if (this.all_user[i].goi_chua == 'dang') {\n            return false;\n          }\n\n          break;\n        }\n      }\n\n      return true;\n    }\n\n    startVideo() {\n      this.is_close_camera = false;\n      this.localStream.getTracks().forEach(function (track) {\n        track.enabled = true;\n      });\n    }\n\n    offVideo() {\n      this.is_close_camera = true;\n      this.localStream.getTracks().forEach(function (track) {\n        track.enabled = false;\n      });\n    }\n\n    close() {\n      // countRequest\n      if (this.status == 1) {\n        this.countRequest = 45;\n      } else if (this.status == 2) {\n        // view\n        this.is_show = false;\n        this.localStream.getTracks().forEach(function (track) {\n          track.stop();\n        });\n        this.is_close_camera = false; // data\n\n        this.closeData();\n      }\n    }\n\n    cuocGoiNho() {\n      // view\n      this.is_show = false;\n      this.localStream.getTracks().forEach(function (track) {\n        track.stop();\n      });\n      this.is_close_camera = false; // data\n\n      this.closeData(); // Tạo tin nhắn cuộc gọi nhỡ\n\n      this.createTinNhan();\n    }\n\n    createTinNhan() {\n      let nowDate = new Date();\n      let gio = nowDate.getHours();\n      let phut = nowDate.getMinutes();\n      let noi_dung = `${gio.toString().length > 1 ? gio : \"0\" + gio}:${phut.toString().length > 1 ? phut : \"0\" + phut}`;\n      this.content_service.sumitTinNhan(this.messenger_main_service.ma_cuoc_tro_chuyen, noi_dung, \"cuoc_goi_nho\", this.my_name_service.myName);\n    }\n\n    closeData() {\n      let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn\"));\n      this.db.object(\"/call_video/\" + this.now_user.ma_tai_khoan).update({\n        goi_chua: \"chua\"\n      });\n      this.db.object(\"/call_video/\" + mtk).update({\n        goi_chua: \"chua\"\n      });\n    }\n\n    cameraGoToLeft() {\n      this.is_camera_go_to_left = !this.is_camera_go_to_left;\n    }\n\n  }\n\n  CallVideoService.ɵfac = function CallVideoService_Factory(t) {\n    return new (t || CallVideoService)(i0.ɵɵinject(i1.AngularFireDatabase), i0.ɵɵinject(i2.MyNameService), i0.ɵɵinject(i3.MainPageService), i0.ɵɵinject(i4.ChatPageChatPageContentService), i0.ɵɵinject(i5.MessengerMainService));\n  };\n\n  CallVideoService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n    token: CallVideoService,\n    factory: CallVideoService.ɵfac,\n    providedIn: 'root'\n  });\n  return CallVideoService;\n})();","map":null,"metadata":{},"sourceType":"module"}