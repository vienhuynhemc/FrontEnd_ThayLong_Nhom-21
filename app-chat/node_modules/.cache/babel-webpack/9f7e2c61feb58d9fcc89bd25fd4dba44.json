{"ast":null,"code":"import _asyncToGenerator from \"E:/Important/FIT/project-front-end/FrontEnd_ThayLong_Nhom-21/app-chat/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport { UserVideoWS } from 'src/app/models/ws/chat-page/call-video/user-video-ws';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/fire/database\";\nimport * as i2 from \"../../my-name/my-name-ws.service\";\nimport * as i3 from \"../../main-page/main-page-ws.service\";\nimport * as i4 from \"../chat-page-chat-page/chat-page-chat-page-content/chat-page-chat-page-content-ws.service\";\nimport * as i5 from \"../chat-page-chat-page/messenger-main-ws.service\";\nexport class CallVideoWsService {\n  constructor(db, my_name_service, main_page_service, content_service, messenger_main_service) {\n    this.db = db;\n    this.my_name_service = my_name_service;\n    this.main_page_service = main_page_service;\n    this.content_service = content_service;\n    this.messenger_main_service = messenger_main_service; // Request mediaDevices\n\n    this.mediaConstraints = {\n      audio: true,\n      video: true\n    }; // All user\n\n    this.all_user = []; // request 45s\n\n    this.countRequest = 0;\n\n    if (this.layAllUser == null) {\n      this.getData();\n    } else {\n      this.layAllUser.unsubscribe();\n      this.getData();\n    }\n  }\n\n  getData() {\n    this.layAllUser = this.db.object(\"/call_video_ws\").snapshotChanges().subscribe(data => {\n      let array = [];\n      let isCall = false;\n      let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\n      Object.entries(data.payload.toJSON()).forEach(([k, v]) => {\n        let o = new UserVideoWS();\n        o.ma_tai_khoan = k;\n        o.bat_may_chua = v['bat_may_chua'];\n        o.goi_chua = v['goi_chua'];\n        o.thoi_gian_goi = v['thoi_gian_goi'];\n        o.thoi_gian_ket_thuc = v['thoi_gian_ket_thuc'];\n        o.tk_goi_minh = v['tk_goi_minh'];\n        o.hinh_tk_goi_minh = v['hinh_tk_goi_minh'];\n        o.ten_tk_goi_minh = v['ten_tk_goi_minh']; // Đang trong cuộc gọi\n\n        if (k == mtk && o.goi_chua == 'dang') {\n          isCall = true;\n        }\n\n        array.push(o);\n      });\n      this.all_user = array;\n\n      if (isCall) {\n        this.is_show = true;\n      } else {\n        this.is_show = false;\n      }\n    });\n  }\n\n  getVideoUserAndShow() {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      _this.localStream = yield navigator.mediaDevices.getUserMedia(_this.mediaConstraints);\n      _this.is_show = true;\n    })();\n  }\n\n  callVideo(tk) {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* () {\n      _this2.now_user = tk; // Check thử available\n\n      if (_this2.isAvailable(tk.ma_tai_khoan)) {\n        // Lấy video\n        _this2.getVideoUserAndShow(); // Cập nhật lại trong firebase\n\n\n        _this2.writeToFirebase(tk); // Time out 45s\n\n\n        _this2.countRequest = 0;\n\n        _this2.request45second(); // Status là gọi\n\n\n        _this2.status = 1;\n      } else {\n        // Lấy video\n        _this2.localStream = null;\n        _this2.is_show = true;\n      }\n    })();\n  }\n\n  request45second() {\n    setTimeout(() => {\n      this.countRequest++;\n\n      if (this.countRequest <= 45) {\n        let isOk = false;\n\n        for (let i = 0; i < this.all_user.length; i++) {\n          if (this.all_user[i].ma_tai_khoan == this.now_user.ma_tai_khoan) {\n            if (this.all_user[i].bat_may_chua == 'roi') {\n              isOk = true;\n            }\n\n            break;\n          }\n        }\n\n        if (!isOk) {\n          this.request45second();\n        } else {\n          // Có người bắt máy\n          // Chuyển status sang bắt máy\n          this.status = 2;\n        }\n      } else {\n        this.cuocGoiNho();\n      }\n    }, 1000);\n  }\n\n  writeToFirebase(tk) {\n    let currentTime = Number(new Date());\n    let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\n    this.db.object(\"/call_video_ws/\" + tk.ma_tai_khoan).update({\n      thoi_gian_goi: currentTime,\n      goi_chua: \"dang\",\n      bat_may_chua: \"chua\",\n      tk_goi_minh: mtk,\n      hinh_tk_goi_minh: this.main_page_service.img,\n      ten_tk_goi_minh: this.my_name_service.myName\n    });\n    this.db.object(\"/call_video_ws/\" + mtk).update({\n      thoi_gian_goi: currentTime,\n      goi_chua: \"dang\",\n      bat_may_chua: \"roi\",\n      tk_goi_minh: 'khong_co',\n      hinh_tk_goi_minh: 'khong_co',\n      ten_tk_goi_minh: 'khong_co'\n    });\n  }\n\n  isAvailable(mtk) {\n    for (let i = 0; i < this.all_user.length; i++) {\n      if (this.all_user[i].ma_tai_khoan == mtk) {\n        if (this.all_user[i].goi_chua == 'dang') {\n          return false;\n        }\n\n        break;\n      }\n    }\n\n    return true;\n  }\n\n  startVideo() {\n    this.is_close_camera = false;\n    this.localStream.getTracks().forEach(function (track) {\n      track.enabled = true;\n    });\n  }\n\n  offVideo() {\n    this.is_close_camera = true;\n    this.localStream.getTracks().forEach(function (track) {\n      track.enabled = false;\n    });\n  }\n\n  close() {\n    // countRequest\n    if (this.status == 1) {\n      this.countRequest = 45;\n    } else if (this.status == 2) {\n      // view\n      this.is_show = false;\n      this.localStream.getTracks().forEach(function (track) {\n        track.stop();\n      });\n      this.is_close_camera = false; // data\n\n      this.closeData();\n    }\n  }\n\n  cuocGoiNho() {\n    // view\n    this.is_show = false;\n    this.localStream.getTracks().forEach(function (track) {\n      track.stop();\n    });\n    this.is_close_camera = false; // data\n\n    this.closeData(); // Tạo tin nhắn cuộc gọi nhỡ\n\n    this.createTinNhan();\n  }\n\n  createTinNhan() {\n    let nowDate = new Date();\n    let gio = nowDate.getHours();\n    let phut = nowDate.getMinutes();\n    let noi_dung = `${gio.toString().length > 1 ? gio : \"0\" + gio}:${phut.toString().length > 1 ? phut : \"0\" + phut}`;\n    this.content_service.sumitTinNhan(this.messenger_main_service.ma_cuoc_tro_chuyen, noi_dung, \"cuoc_goi_nho\", this.my_name_service.myName);\n  }\n\n  closeData() {\n    let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\n    this.db.object(\"/call_video_ws/\" + this.now_user.ma_tai_khoan).update({\n      goi_chua: \"chua\"\n    });\n    this.db.object(\"/call_video_ws/\" + mtk).update({\n      goi_chua: \"chua\"\n    });\n  }\n\n  cameraGoToLeft() {\n    this.is_camera_go_to_left = !this.is_camera_go_to_left;\n  }\n\n}\n\nCallVideoWsService.ɵfac = function CallVideoWsService_Factory(t) {\n  return new (t || CallVideoWsService)(i0.ɵɵinject(i1.AngularFireDatabase), i0.ɵɵinject(i2.MyNameWsService), i0.ɵɵinject(i3.MainPageWsService), i0.ɵɵinject(i4.ChatPageChatPageContentWsService), i0.ɵɵinject(i5.MessengerMainWsService));\n};\n\nCallVideoWsService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: CallVideoWsService,\n  factory: CallVideoWsService.ɵfac,\n  providedIn: 'root'\n});","map":{"version":3,"sources":["E:\\Important\\FIT\\project-front-end\\FrontEnd_ThayLong_Nhom-21\\app-chat\\src\\app\\service\\ws\\chat-page\\call-video\\call-video-ws.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable } from '@angular/core';\r\nimport { AngularFireDatabase } from '@angular/fire/database';\r\nimport { Subscription } from 'rxjs';\r\nimport { UserVideoWS } from 'src/app/models/ws/chat-page/call-video/user-video-ws';\r\nimport { ObjectChatThanhVienWS } from 'src/app/models/ws/chat-page/chat-page-chat-page/header/object_chat_thanh_vien_ws';\r\nimport { MainPageWsService } from '../../main-page/main-page-ws.service';\r\nimport { MyNameWsService } from '../../my-name/my-name-ws.service';\r\nimport { ChatPageChatPageContentWsService } from '../chat-page-chat-page/chat-page-chat-page-content/chat-page-chat-page-content-ws.service';\r\nimport { MessengerMainWsService } from '../chat-page-chat-page/messenger-main-ws.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CallVideoWsService {\r\n  // Request mediaDevices\r\n  public mediaConstraints = {\r\n    audio: true,\r\n    video: true\r\n  }\r\n\r\n  // localStream\r\n  public localStream: MediaStream;\r\n\r\n  // is show component call video\r\n  public is_show: boolean;\r\n\r\n  // Trạng thái camera bật hay tắt\r\n  public is_close_camera: boolean;\r\n  // Trạng thái my camera go to left\r\n  public is_camera_go_to_left: boolean;\r\n\r\n  // All user\r\n  public all_user: UserVideoWS[] = [];\r\n  // user đang tương tác\r\n  public now_user: ObjectChatThanhVienWS;\r\n  // request 45s\r\n  public countRequest = 0;\r\n  // Trạng thái \r\n  public status: number;\r\n\r\n  // service\r\n  public layAllUser: Subscription;\r\n\r\n  constructor(\r\n    private db: AngularFireDatabase,\r\n    private my_name_service: MyNameWsService,\r\n    private main_page_service: MainPageWsService,\r\n    private content_service: ChatPageChatPageContentWsService,\r\n    private messenger_main_service: MessengerMainWsService\r\n  ) {\r\n    if (this.layAllUser == null) {\r\n      this.getData();\r\n    } else {\r\n      this.layAllUser.unsubscribe();\r\n      this.getData();\r\n    }\r\n  }\r\n\r\n  public getData() {\r\n    this.layAllUser = this.db.object(\"/call_video_ws\").snapshotChanges().subscribe(data => {\r\n      let array: UserVideoWS[] = [];\r\n      let isCall = false;\r\n      let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n      Object.entries(data.payload.toJSON()).forEach(([k, v]) => {\r\n        let o = new UserVideoWS();\r\n        o.ma_tai_khoan = k;\r\n        o.bat_may_chua = v['bat_may_chua'];\r\n        o.goi_chua = v['goi_chua'];\r\n        o.thoi_gian_goi = v['thoi_gian_goi'];\r\n        o.thoi_gian_ket_thuc = v['thoi_gian_ket_thuc'];\r\n        o.tk_goi_minh = v['tk_goi_minh'];\r\n        o.hinh_tk_goi_minh = v['hinh_tk_goi_minh'];\r\n        o.ten_tk_goi_minh = v['ten_tk_goi_minh'];\r\n        // Đang trong cuộc gọi\r\n        if (k == mtk && o.goi_chua == 'dang') {\r\n          isCall = true;\r\n        }\r\n        array.push(o);\r\n      });\r\n      this.all_user = array;\r\n      if (isCall) {\r\n        this.is_show = true;\r\n      }else{\r\n        this.is_show = false;\r\n      }\r\n    })\r\n  }\r\n\r\n  public async getVideoUserAndShow() {\r\n    this.localStream = await navigator.mediaDevices.getUserMedia(this.mediaConstraints);\r\n    this.is_show = true;\r\n  }\r\n\r\n  public async callVideo(tk: ObjectChatThanhVienWS) {\r\n    this.now_user = tk;\r\n    // Check thử available\r\n    if (this.isAvailable(tk.ma_tai_khoan)) {\r\n      // Lấy video\r\n      this.getVideoUserAndShow();\r\n      // Cập nhật lại trong firebase\r\n      this.writeToFirebase(tk);\r\n      // Time out 45s\r\n      this.countRequest = 0;\r\n      this.request45second();\r\n      // Status là gọi\r\n      this.status = 1;\r\n    } else {\r\n      // Lấy video\r\n      this.localStream = null;\r\n      this.is_show = true;\r\n    }\r\n  }\r\n\r\n  public request45second() {\r\n    setTimeout(() => {\r\n      this.countRequest++;\r\n      if (this.countRequest <= 45) {\r\n        let isOk = false;\r\n        for (let i = 0; i < this.all_user.length; i++) {\r\n          if (this.all_user[i].ma_tai_khoan == this.now_user.ma_tai_khoan) {\r\n            if (this.all_user[i].bat_may_chua == 'roi') {\r\n              isOk = true;\r\n            }\r\n            break;\r\n          }\r\n        }\r\n        if (!isOk) {\r\n          this.request45second();\r\n        } else {\r\n          // Có người bắt máy\r\n          // Chuyển status sang bắt máy\r\n          this.status = 2;\r\n        }\r\n      } else {\r\n        this.cuocGoiNho();\r\n      }\r\n    }, 1000);\r\n  }\r\n\r\n  public writeToFirebase(tk: ObjectChatThanhVienWS) {\r\n    let currentTime = Number(new Date());\r\n    let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n    this.db.object(\"/call_video_ws/\" + tk.ma_tai_khoan).update({\r\n      thoi_gian_goi: currentTime,\r\n      goi_chua: \"dang\",\r\n      bat_may_chua: \"chua\",\r\n      tk_goi_minh: mtk,\r\n      hinh_tk_goi_minh: this.main_page_service.img,\r\n      ten_tk_goi_minh: this.my_name_service.myName\r\n    });\r\n    this.db.object(\"/call_video_ws/\" + mtk).update({\r\n      thoi_gian_goi: currentTime,\r\n      goi_chua: \"dang\",\r\n      bat_may_chua: \"roi\",\r\n      tk_goi_minh: 'khong_co',\r\n      hinh_tk_goi_minh: 'khong_co',\r\n      ten_tk_goi_minh: 'khong_co'\r\n    });\r\n  }\r\n\r\n  public isAvailable(mtk: string): boolean {\r\n    for (let i = 0; i < this.all_user.length; i++) {\r\n      if (this.all_user[i].ma_tai_khoan == mtk) {\r\n        if (this.all_user[i].goi_chua == 'dang') {\r\n          return false;\r\n        }\r\n        break;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public startVideo() {\r\n    this.is_close_camera = false\r\n    this.localStream.getTracks().forEach(function (track) {\r\n      track.enabled = true;\r\n    });\r\n  }\r\n\r\n  public offVideo() {\r\n    this.is_close_camera = true;\r\n    this.localStream.getTracks().forEach(function (track) {\r\n      track.enabled = false;\r\n    });\r\n  }\r\n\r\n  public close() {\r\n    // countRequest\r\n    if (this.status == 1) {\r\n      this.countRequest = 45;\r\n    } else if (this.status == 2) {\r\n      // view\r\n      this.is_show = false;\r\n      this.localStream.getTracks().forEach(function (track) {\r\n        track.stop();\r\n      });\r\n      this.is_close_camera = false;\r\n      // data\r\n      this.closeData();\r\n    }\r\n  }\r\n\r\n  public cuocGoiNho() {\r\n    // view\r\n    this.is_show = false;\r\n    this.localStream.getTracks().forEach(function (track) {\r\n      track.stop();\r\n    });\r\n    this.is_close_camera = false;\r\n    // data\r\n    this.closeData();\r\n    // Tạo tin nhắn cuộc gọi nhỡ\r\n    this.createTinNhan();\r\n  }\r\n\r\n  public createTinNhan() {\r\n    let nowDate = new Date();\r\n    let gio = nowDate.getHours();\r\n    let phut = nowDate.getMinutes();\r\n    let noi_dung = `${gio.toString().length > 1 ? gio : \"0\" + gio}:${phut.toString().length > 1 ? phut : \"0\" + phut}`\r\n    this.content_service.sumitTinNhan(this.messenger_main_service.ma_cuoc_tro_chuyen, noi_dung, \"cuoc_goi_nho\", this.my_name_service.myName);\r\n  }\r\n\r\n  public closeData() {\r\n    let mtk = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n    this.db.object(\"/call_video_ws/\" + this.now_user.ma_tai_khoan).update({\r\n      goi_chua: \"chua\",\r\n    });\r\n    this.db.object(\"/call_video_ws/\" + mtk).update({\r\n      goi_chua: \"chua\",\r\n    });\r\n  }\r\n\r\n  public cameraGoToLeft() {\r\n    this.is_camera_go_to_left = !this.is_camera_go_to_left;\r\n  }\r\n}\r\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}