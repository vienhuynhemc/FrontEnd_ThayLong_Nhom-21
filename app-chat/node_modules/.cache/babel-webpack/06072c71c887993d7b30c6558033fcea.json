{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/Administrator/Desktop/FrontEnd_ThayLong_Nhom-21/app-chat/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/fire/database\";\nimport * as i2 from \"./main-page-websocket.service\";\nexport class MainPageWsService {\n  constructor(db, main_page_websocket) {\n    this.db = db;\n    this.main_page_websocket = main_page_websocket;\n    this.trang_chu_duoc_chon = false;\n    this.tin_nhan_duoc_chon = false;\n    this.tin_nhan_an_duoc_chon = false;\n    this.ban_be_duoc_chon = false;\n    this.thong_tin_ca_nhan_duoc_chon = false;\n    this.cai_dat_duoc_chon = false;\n    this.updateOnline();\n  }\n\n  getImg() {\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\n    return this.db.object(\"/tai_khoan_ws/\" + ma_tai_khoan).snapshotChanges();\n  }\n\n  setImg(object) {\n    this.img = object['link_hinh'];\n  }\n\n  updateOnline() {\n    setTimeout(() => {\n      let currentTime = Number(new Date());\n      let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\n\n      if (ma_tai_khoan != null) {\n        this.db.object(\"/lan_cuoi_dang_nhap_ws/\" + ma_tai_khoan).update({\n          lan_cuoi_dang_nhap: currentTime\n        });\n      }\n\n      this.updateOnline();\n    }, 5000);\n  }\n\n  autoJoinGroup() {\n    var _this = this;\n\n    // join group tự động\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\")); // lấy ra tất cả cuộc trò chuyện\n\n    this.db.database.ref('cuoc_tro_chuyen_ws').on('value', group => {\n      group.forEach(gDetail => {\n        // lấy ra cuộc trò chuyện nhóm\n        if (gDetail.val().loai_cuoc_tro_truyen == 'nhom') {\n          // kiểm tra bản thân đã tham gia nhóm chưa\n          this.db.database.ref('thanh_vien_cuoc_tro_chuyen_ws').child(gDetail.key).child(ma_tai_khoan).on('value', member => {\n            if (member.val() != null) {\n              if (member.val().tham_gia == 'chua') {\n                // chưa tham gia thì gửi request join group\n                this.db.database.ref('thong_tin_tro_chuyen_nhom_ws').child(gDetail.key).once('value', inforG => {\n                  this.main_page_websocket.joinGroup(inforG.val().ten_nhom);\n                  this.main_page_websocket.messages_join_group.subscribe( /*#__PURE__*/function () {\n                    var _ref = _asyncToGenerator(function* (data) {\n                      setTimeout(() => {\n                        let value = JSON.parse(JSON.stringify(data));\n\n                        if (value.status == \"success\") {\n                          console.log(value.data); // tham gia thành công thì set lại trong fire\n\n                          _this.db.database.ref('thanh_vien_cuoc_tro_chuyen_ws').child(gDetail.key).child(ma_tai_khoan).update({\n                            tham_gia: 'roi'\n                          });\n                        }\n                      }, 1000);\n                    });\n\n                    return function (_x) {\n                      return _ref.apply(this, arguments);\n                    };\n                  }());\n                });\n              }\n            }\n          });\n        }\n      });\n    });\n  }\n\n  selectTrangChu() {\n    this.trang_chu_duoc_chon = true;\n  }\n\n  selectPersonalPage() {\n    this.thong_tin_ca_nhan_duoc_chon = true;\n  }\n\n  selectSettingPage() {\n    this.cai_dat_duoc_chon = true;\n  }\n\n  selectFriendsPage() {\n    this.ban_be_duoc_chon = true;\n  }\n\n  selectChatRequestPage() {\n    this.tin_nhan_an_duoc_chon = true;\n  }\n\n  selectChatPage() {\n    this.tin_nhan_duoc_chon = true;\n  }\n\n  reset() {\n    this.trang_chu_duoc_chon = false;\n    this.tin_nhan_duoc_chon = false;\n    this.tin_nhan_an_duoc_chon = false;\n    this.ban_be_duoc_chon = false;\n    this.thong_tin_ca_nhan_duoc_chon = false;\n    this.cai_dat_duoc_chon = false;\n  }\n\n  isSelectHomePage() {\n    return this.trang_chu_duoc_chon;\n  }\n\n  isSelectChatPage() {\n    return this.tin_nhan_duoc_chon;\n  }\n\n  isSelectChatRequestPage() {\n    return this.tin_nhan_an_duoc_chon;\n  }\n\n  isSelectFriendsPage() {\n    return this.ban_be_duoc_chon;\n  }\n\n  isSelectPersonalPage() {\n    return this.thong_tin_ca_nhan_duoc_chon;\n  }\n\n  isSelectSettingPage() {\n    return this.cai_dat_duoc_chon;\n  }\n\n}\n\nMainPageWsService.ɵfac = function MainPageWsService_Factory(t) {\n  return new (t || MainPageWsService)(i0.ɵɵinject(i1.AngularFireDatabase), i0.ɵɵinject(i2.MainPageWebsocketService));\n};\n\nMainPageWsService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: MainPageWsService,\n  factory: MainPageWsService.ɵfac,\n  providedIn: 'root'\n});","map":{"version":3,"sources":["C:\\Users\\Administrator\\Desktop\\FrontEnd_ThayLong_Nhom-21\\app-chat\\src\\app\\service\\ws\\main-page\\main-page-ws.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable } from '@angular/core';\r\nimport { AngularFireDatabase } from '@angular/fire/database';\r\nimport { Subscription } from 'rxjs';\r\nimport { MainPageWebsocketService } from './main-page-websocket.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MainPageWsService {\r\n\r\n  public img: string;\r\n\r\n  // Mục đích để xử tô xanh cái icon bên trái\r\n  private trang_chu_duoc_chon: boolean;\r\n  private tin_nhan_duoc_chon: boolean;\r\n  private tin_nhan_an_duoc_chon: boolean;\r\n  private ban_be_duoc_chon: boolean;\r\n  private thong_tin_ca_nhan_duoc_chon: boolean;\r\n  private cai_dat_duoc_chon: boolean;\r\n\r\n  // Service\r\n  // 1. Lấy hình\r\n  public layHinh: Subscription;\r\n\r\n  constructor(\r\n    private db: AngularFireDatabase,\r\n    private main_page_websocket: MainPageWebsocketService\r\n  ) {\r\n    this.trang_chu_duoc_chon = false;\r\n    this.tin_nhan_duoc_chon = false;\r\n    this.tin_nhan_an_duoc_chon = false;\r\n    this.ban_be_duoc_chon = false;\r\n    this.thong_tin_ca_nhan_duoc_chon = false;\r\n    this.cai_dat_duoc_chon = false;\r\n    this.updateOnline();\r\n    \r\n  }\r\n\r\n  public getImg() {\r\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n    return this.db.object(\"/tai_khoan_ws/\" + ma_tai_khoan).snapshotChanges();\r\n  }\r\n\r\n  public setImg(object: Object) {\r\n    this.img = object['link_hinh'];\r\n  }\r\n\r\n  public updateOnline(): void {\r\n    setTimeout(() => {\r\n      let currentTime = Number(new Date());\r\n      let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n      if (ma_tai_khoan != null) {\r\n        this.db.object(\"/lan_cuoi_dang_nhap_ws/\" + ma_tai_khoan).update({ lan_cuoi_dang_nhap: currentTime });\r\n      }\r\n      \r\n      this.updateOnline();\r\n    }, 5000);\r\n  }\r\n  public autoJoinGroup() {\r\n    // join group tự động\r\n    let ma_tai_khoan = JSON.parse(localStorage.getItem(\"ma_tai_khoan_dn_ws\"));\r\n    // lấy ra tất cả cuộc trò chuyện\r\n    this.db.database.ref('cuoc_tro_chuyen_ws').on('value', group => {\r\n      group.forEach(gDetail => {\r\n        // lấy ra cuộc trò chuyện nhóm\r\n        if(gDetail.val().loai_cuoc_tro_truyen == 'nhom') {\r\n          // kiểm tra bản thân đã tham gia nhóm chưa\r\n          this.db.database.ref('thanh_vien_cuoc_tro_chuyen_ws').child(gDetail.key).child(ma_tai_khoan).on('value', member =>{\r\n              if(member.val() != null ) {\r\n                if(member.val().tham_gia == 'chua') {\r\n                  // chưa tham gia thì gửi request join group\r\n                  this.db.database.ref('thong_tin_tro_chuyen_nhom_ws').child(gDetail.key).once('value', inforG => {\r\n                    this.main_page_websocket.joinGroup(inforG.val().ten_nhom);\r\n                    this.main_page_websocket.messages_join_group.subscribe(async data => {\r\n                      setTimeout(() => {\r\n                        let value = JSON.parse(JSON.stringify(data));\r\n                        if (value.status == \"success\") {\r\n                          console.log(value.data)\r\n                          // tham gia thành công thì set lại trong fire\r\n                          this.db.database.ref('thanh_vien_cuoc_tro_chuyen_ws').child(gDetail.key).child(ma_tai_khoan).update({\r\n                            tham_gia: 'roi'\r\n                          })\r\n                        }\r\n                      }, 1000);\r\n                    })\r\n                  })\r\n                }\r\n              }\r\n          })\r\n        }\r\n      });\r\n    })\r\n  }\r\n  public selectTrangChu(): void {\r\n    this.trang_chu_duoc_chon = true;\r\n  }\r\n\r\n  public selectPersonalPage(): void {\r\n    this.thong_tin_ca_nhan_duoc_chon = true;\r\n  }\r\n\r\n  public selectSettingPage(): void {\r\n    this.cai_dat_duoc_chon = true;\r\n  }\r\n\r\n  public selectFriendsPage(): void {\r\n    this.ban_be_duoc_chon = true;\r\n  }\r\n\r\n  public selectChatRequestPage(): void {\r\n    this.tin_nhan_an_duoc_chon = true;\r\n  }\r\n\r\n  public selectChatPage(): void {\r\n    this.tin_nhan_duoc_chon = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this.trang_chu_duoc_chon = false;\r\n    this.tin_nhan_duoc_chon = false;\r\n    this.tin_nhan_an_duoc_chon = false;\r\n    this.ban_be_duoc_chon = false;\r\n    this.thong_tin_ca_nhan_duoc_chon = false;\r\n    this.cai_dat_duoc_chon = false;\r\n  }\r\n\r\n  public isSelectHomePage(): boolean {\r\n    return this.trang_chu_duoc_chon;\r\n  }\r\n\r\n  public isSelectChatPage(): boolean {\r\n    return this.tin_nhan_duoc_chon;\r\n  }\r\n\r\n  public isSelectChatRequestPage(): boolean {\r\n    return this.tin_nhan_an_duoc_chon;\r\n  }\r\n\r\n  public isSelectFriendsPage(): boolean {\r\n    return this.ban_be_duoc_chon;\r\n  }\r\n\r\n  public isSelectPersonalPage(): boolean {\r\n    return this.thong_tin_ca_nhan_duoc_chon;\r\n  }\r\n\r\n  public isSelectSettingPage(): boolean {\r\n    return this.cai_dat_duoc_chon;\r\n  }\r\n\r\n}\r\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}